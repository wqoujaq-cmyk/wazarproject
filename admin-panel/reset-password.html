<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - University E-Voting System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --primary-dark: #1e3a8a;
            --success: #059669;
            --error: #dc2626;
            --warning: #d97706;
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Animated background pattern */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(6, 182, 212, 0.1) 0%, transparent 40%);
            pointer-events: none;
        }

        /* Floating shapes animation */
        .floating-shape {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: float 20s infinite ease-in-out;
        }

        .shape-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            top: -200px;
            right: -100px;
            animation-delay: 0s;
        }

        .shape-2 {
            width: 300px;
            height: 300px;
            background: linear-gradient(45deg, #06b6d4, #3b82f6);
            bottom: -150px;
            left: -100px;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(30px, 30px) rotate(5deg); }
            50% { transform: translate(0, 50px) rotate(0deg); }
            75% { transform: translate(-30px, 30px) rotate(-5deg); }
        }

        .container {
            width: 100%;
            max-width: 440px;
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 48px 40px;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            box-shadow: 0 10px 30px rgba(30, 64, 175, 0.3);
        }

        .logo-icon span {
            font-size: 36px;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 15px;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Step indicators */
        .steps-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }

        .step-dot.completed {
            background: var(--success);
        }

        /* Form styles */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
        }

        .form-input.error {
            border-color: var(--error);
        }

        .form-input.success {
            border-color: var(--success);
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .toggle-password:hover {
            opacity: 1;
        }

        /* Password strength indicator */
        .password-strength {
            margin-top: 12px;
        }

        .strength-bar {
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            overflow: hidden;
            margin-bottom: 8px;
        }

        .strength-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease, background 0.3s ease;
            width: 0%;
        }

        .strength-text {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Button styles */
        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background: var(--border);
            color: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(30, 64, 175, 0.05);
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert messages */
        .alert {
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: var(--error);
        }

        .alert-success {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.2);
            color: var(--success);
        }

        .alert-warning {
            background: rgba(217, 119, 6, 0.1);
            border: 1px solid rgba(217, 119, 6, 0.2);
            color: var(--warning);
        }

        /* Success view */
        .success-view {
            text-align: center;
            padding: 20px 0;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        .success-icon span {
            font-size: 40px;
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .success-message {
            font-size: 15px;
            color: var(--text-light);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        /* Hide/show sections */
        .hidden {
            display: none !important;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer-text {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Requirements list */
        .requirements {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(30, 64, 175, 0.05);
            border-radius: 8px;
        }

        .requirements-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .requirement {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .requirement.met {
            color: var(--success);
        }

        .requirement-icon {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>

    <div class="container">
        <div class="card">
            <!-- Logo -->
            <div class="logo-container">
                <div class="logo-icon">
                    <span>üîê</span>
                </div>
                <h1 class="title">Reset Password</h1>
                <p class="subtitle" id="stepSubtitle">Enter your University ID and verification code to reset your password</p>
            </div>

            <!-- Step Indicators -->
            <div class="steps-container">
                <div class="step-dot active" id="step1Dot"></div>
                <div class="step-dot" id="step2Dot"></div>
                <div class="step-dot" id="step3Dot"></div>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Step 1: Verify Identity -->
            <form id="verifyForm">
                <div class="form-group">
                    <label class="form-label" for="universityId">University ID</label>
                    <input 
                        type="text" 
                        id="universityId" 
                        class="form-input" 
                        placeholder="e.g., ENG001"
                        autocomplete="off"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="resetToken">Reset Token</label>
                    <input 
                        type="text" 
                        id="resetToken" 
                        class="form-input" 
                        placeholder="Enter the 6-digit code from your email"
                        maxlength="6"
                        autocomplete="off"
                        required
                    >
                </div>

                <button type="submit" class="btn btn-primary" id="verifyBtn">
                    <span>Verify Identity</span>
                </button>
            </form>

            <!-- Step 2: New Password -->
            <form id="passwordForm" class="hidden">
                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            id="newPassword" 
                            class="form-input" 
                            placeholder="Enter new password"
                            autocomplete="new-password"
                            required
                        >
                        <button type="button" class="toggle-password" onclick="togglePassword('newPassword')">üëÅÔ∏è</button>
                    </div>
                    
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <span class="strength-text" id="strengthText">Enter a password</span>
                    </div>

                    <div class="requirements">
                        <div class="requirements-title">Password requirements:</div>
                        <div class="requirement" id="reqLength">
                            <span class="requirement-icon">‚óã</span>
                            <span>At least 8 characters</span>
                        </div>
                        <div class="requirement" id="reqUpper">
                            <span class="requirement-icon">‚óã</span>
                            <span>One uppercase letter</span>
                        </div>
                        <div class="requirement" id="reqLower">
                            <span class="requirement-icon">‚óã</span>
                            <span>One lowercase letter</span>
                        </div>
                        <div class="requirement" id="reqNumber">
                            <span class="requirement-icon">‚óã</span>
                            <span>One number</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Confirm Password</label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            class="form-input" 
                            placeholder="Confirm new password"
                            autocomplete="new-password"
                            required
                        >
                        <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">üëÅÔ∏è</button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="resetBtn" disabled>
                    <span>Reset Password</span>
                </button>
            </form>

            <!-- Step 3: Success -->
            <div id="successView" class="hidden">
                <div class="success-view">
                    <div class="success-icon">
                        <span>‚úì</span>
                    </div>
                    <h2 class="success-title">Request Submitted!</h2>
                    <p class="success-message">
                        Your password reset request has been submitted successfully. The administrator will process your request and you will receive an email notification at your registered contact email with your new login credentials.
                    </p>
                    <p class="success-message" style="font-size: 13px; margin-top: 12px; color: #64748b;">
                        ‚è±Ô∏è This usually takes less than 24 hours during business days.
                    </p>
                    <button onclick="window.close()" class="btn btn-secondary" style="margin-top: 20px;">
                        Close This Page
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p class="footer-text">
                    Need help? <a href="mailto:support@university.edu">Contact Support</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            updatePassword,
            signOut
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            query, 
            where, 
            updateDoc,
            deleteDoc,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCw3WEk0MShGTwLEpO7I8Y85Jv97n06fc4",
            authDomain: "wazar-1a851.firebaseapp.com",
            projectId: "wazar-1a851",
            storageBucket: "wazar-1a851.firebasestorage.app",
            messagingSenderId: "1091521735952",
            appId: "1:1091521735952:web:4c04c10f77e9c71e9c1dfe"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let verifiedUserId = null;
        let verifiedUserEmail = null;
        let verifiedTokenDocId = null;

        // DOM Elements
        const verifyForm = document.getElementById('verifyForm');
        const passwordForm = document.getElementById('passwordForm');
        const successView = document.getElementById('successView');
        const alertContainer = document.getElementById('alertContainer');
        const stepSubtitle = document.getElementById('stepSubtitle');
        const step1Dot = document.getElementById('step1Dot');
        const step2Dot = document.getElementById('step2Dot');
        const step3Dot = document.getElementById('step3Dot');

        // Check URL params for pre-filled token
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        const urlId = urlParams.get('id');
        
        if (urlToken) {
            document.getElementById('resetToken').value = urlToken;
        }
        if (urlId) {
            document.getElementById('universityId').value = urlId.toUpperCase();
        }

        // Show alert
        function showAlert(type, message) {
            const icons = {
                error: '‚ùå',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è'
            };
            
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    <span class="alert-icon">${icons[type]}</span>
                    <span>${message}</span>
                </div>
            `;
        }

        function clearAlert() {
            alertContainer.innerHTML = '';
        }

        // Toggle password visibility
        window.togglePassword = function(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        };

        // Password strength checker
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const resetBtn = document.getElementById('resetBtn');
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');

        newPasswordInput.addEventListener('input', checkPasswordStrength);
        confirmPasswordInput.addEventListener('input', validatePasswords);

        function checkPasswordStrength() {
            const password = newPasswordInput.value;
            let strength = 0;
            let met = { length: false, upper: false, lower: false, number: false };

            if (password.length >= 8) { strength++; met.length = true; }
            if (/[A-Z]/.test(password)) { strength++; met.upper = true; }
            if (/[a-z]/.test(password)) { strength++; met.lower = true; }
            if (/[0-9]/.test(password)) { strength++; met.number = true; }

            // Update requirement indicators
            updateRequirement('reqLength', met.length);
            updateRequirement('reqUpper', met.upper);
            updateRequirement('reqLower', met.lower);
            updateRequirement('reqNumber', met.number);

            // Update strength bar
            const colors = ['var(--error)', 'var(--warning)', '#eab308', 'var(--success)'];
            const texts = ['Weak', 'Fair', 'Good', 'Strong'];
            const widths = ['25%', '50%', '75%', '100%'];

            if (password.length === 0) {
                strengthFill.style.width = '0%';
                strengthText.textContent = 'Enter a password';
            } else {
                strengthFill.style.width = widths[strength - 1] || '0%';
                strengthFill.style.background = colors[strength - 1] || colors[0];
                strengthText.textContent = texts[strength - 1] || 'Very weak';
            }

            validatePasswords();
        }

        function updateRequirement(id, met) {
            const el = document.getElementById(id);
            if (met) {
                el.classList.add('met');
                el.querySelector('.requirement-icon').textContent = '‚úì';
            } else {
                el.classList.remove('met');
                el.querySelector('.requirement-icon').textContent = '‚óã';
            }
        }

        function validatePasswords() {
            const password = newPasswordInput.value;
            const confirm = confirmPasswordInput.value;
            
            const isStrong = password.length >= 8 && 
                           /[A-Z]/.test(password) && 
                           /[a-z]/.test(password) && 
                           /[0-9]/.test(password);
            const matches = password === confirm && confirm.length > 0;

            resetBtn.disabled = !(isStrong && matches);

            if (confirm.length > 0 && !matches) {
                confirmPasswordInput.classList.add('error');
                confirmPasswordInput.classList.remove('success');
            } else if (matches) {
                confirmPasswordInput.classList.remove('error');
                confirmPasswordInput.classList.add('success');
            } else {
                confirmPasswordInput.classList.remove('error', 'success');
            }
        }

        // Step 1: Verify Identity
        verifyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAlert();

            const universityId = document.getElementById('universityId').value.toUpperCase().trim();
            const token = document.getElementById('resetToken').value.trim();

            if (!universityId || !token) {
                showAlert('error', 'Please fill in all fields');
                return;
            }

            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<div class="spinner"></div>';

            try {
                // Find user by university_id
                const usersQuery = query(
                    collection(db, 'Users'),
                    where('university_id', '==', universityId)
                );
                const usersSnapshot = await getDocs(usersQuery);

                if (usersSnapshot.empty) {
                    throw new Error('No account found with this University ID');
                }

                const userDoc = usersSnapshot.docs[0];
                const userData = userDoc.data();

                // Find valid reset token
                const tokensQuery = query(
                    collection(db, 'PasswordResetTokens'),
                    where('university_id', '==', universityId),
                    where('token', '==', token),
                    where('used', '==', false)
                );
                const tokensSnapshot = await getDocs(tokensQuery);

                if (tokensSnapshot.empty) {
                    throw new Error('Invalid or expired reset token. Please request a new one.');
                }

                const tokenDoc = tokensSnapshot.docs[0];
                const tokenData = tokenDoc.data();

                // Check if token is expired (24 hours)
                const expiryTime = tokenData.created_at.toDate();
                expiryTime.setHours(expiryTime.getHours() + 24);
                
                if (new Date() > expiryTime) {
                    throw new Error('This reset token has expired. Please request a new one.');
                }

                // Store verified info
                verifiedUserId = userDoc.id;
                verifiedUserEmail = `${universityId.toLowerCase()}@university.edu`;
                verifiedTokenDocId = tokenDoc.id;

                // Move to step 2
                verifyForm.classList.add('hidden');
                passwordForm.classList.remove('hidden');
                step1Dot.classList.remove('active');
                step1Dot.classList.add('completed');
                step2Dot.classList.add('active');
                stepSubtitle.textContent = 'Create a new secure password for your account';

                showAlert('success', `Identity verified for ${userData.name}. Please set your new password.`);

            } catch (error) {
                console.error('Verification error:', error);
                showAlert('error', error.message || 'Verification failed. Please try again.');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<span>Verify Identity</span>';
            }
        });

        // Step 2: Reset Password
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAlert();

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword !== confirmPassword) {
                showAlert('error', 'Passwords do not match');
                return;
            }

            resetBtn.disabled = true;
            resetBtn.innerHTML = '<div class="spinner"></div>';

            try {
                // Get user document
                const userDocRef = doc(db, 'Users', verifiedUserId);
                const userDocSnap = await getDoc(userDocRef);
                
                if (!userDocSnap.exists()) {
                    throw new Error('User not found');
                }

                const userData = userDocSnap.data();

                // Update the token with the requested new password
                // The admin will see this and process it
                await updateDoc(doc(db, 'PasswordResetTokens', verifiedTokenDocId), {
                    requested_password: newPassword,
                    password_submitted: true,
                    submitted_at: new Date(),
                    user_name: userData.name || 'Unknown',
                    contact_email: userData.contact_email || ''
                });

                // Mark user as having a pending password reset
                await updateDoc(userDocRef, {
                    password_reset_pending: true,
                    password_reset_requested_at: new Date()
                });
                
                // Show success
                passwordForm.classList.add('hidden');
                successView.classList.remove('hidden');
                step2Dot.classList.remove('active');
                step2Dot.classList.add('completed');
                step3Dot.classList.add('active');
                stepSubtitle.textContent = '';

            } catch (error) {
                console.error('Password reset error:', error);
                showAlert('error', error.message || 'Failed to submit password reset request. Please try again.');
                resetBtn.disabled = false;
                resetBtn.innerHTML = '<span>Reset Password</span>';
            }
        });
    </script>
</body>
</html>

