import{initializeApp as me,deleteApp as Le}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";import{getAuth as pe,onAuthStateChanged as De,signOut as U,signInWithEmailAndPassword as _e,createUserWithEmailAndPassword as Ce}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";import{getFirestore as be,getDoc as P,doc as v,getDocs as f,collection as g,deleteDoc as C,updateDoc as V,Timestamp as h,setDoc as xe,addDoc as x,query as j,where as K}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";import{getStorage as Te}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const Me={apiKey:"AIzaSyApJ-yf788oQncbo2p3E0V9BMAyLEhY_cY",authDomain:"universityevoting2.firebaseapp.com",projectId:"universityevoting2",storageBucket:"universityevoting2.firebasestorage.app",messagingSenderId:"681736971312",appId:"1:681736971312:web:51ff23b2ce275e461ff9f5"},J=me(Me),T=pe(J),m=be(J);Te(J);const u={USERS:"Users",ELECTIONS:"Elections",CANDIDATES:"Candidates",VOTES:"Votes",POLLS:"Polls",POLL_OPTIONS:"PollOptions",POLL_VOTES:"PollVotes"};let k=null;function Ne(){De(T,async e=>{if(e)try{const t=await P(v(m,u.USERS,e.uid));if(t.exists()){const o=t.data();o.role==="admin"?(k=o,Ae()):(await U(T),W("Access denied. Admin privileges required."),F())}else await U(T),W("User data not found"),F()}catch(t){console.error("Error checking user:",t),W("Error loading user data"),F()}else k=null,F()}),document.getElementById("loginForm").addEventListener("submit",Pe),document.getElementById("logoutBtn").addEventListener("click",$e)}async function Pe(e){e.preventDefault();const t=document.getElementById("emailInput").value,o=document.getElementById("passwordInput").value,a=document.getElementById("loginError"),n=document.getElementById("loginBtn"),s=document.getElementById("loginBtnText"),l=document.getElementById("loginBtnSpinner");n.disabled=!0,s.style.display="none",l.style.display="block",a.textContent="";try{await _e(T,t,o)}catch(c){console.error("Login error:",c);let i="Login failed. Please try again.";switch(c.code){case"auth/invalid-email":i="Invalid email address";break;case"auth/user-disabled":i="This account has been disabled";break;case"auth/user-not-found":i="No account found with this email";break;case"auth/wrong-password":i="Incorrect password";break}a.textContent=i}finally{n.disabled=!1,s.style.display="block",l.style.display="none"}}async function $e(){try{await U(T)}catch(e){console.error("Logout error:",e),alert("Error logging out")}}function F(){document.getElementById("loginScreen").style.display="block",document.getElementById("dashboardScreen").style.display="none"}function Ae(){document.getElementById("loginScreen").style.display="none",document.getElementById("dashboardScreen").style.display="block",k&&(document.getElementById("adminName").textContent=k.name||"Admin",Oe())}function W(e){document.getElementById("loginError").textContent=e}function ye(e){var n,s;const t=new Date,o=(n=e.start_date)!=null&&n.toDate?e.start_date.toDate():new Date(e.start_date),a=(s=e.end_date)!=null&&s.toDate?e.end_date.toDate():new Date(e.end_date);return t<o?"scheduled":t>=o&&t<=a?"active":"closed"}async function Oe(){try{const e=await f(g(m,u.ELECTIONS)),t=[];e.forEach(s=>{t.push({id:s.id,...s.data()})}),document.getElementById("totalElections").textContent=t.length;const o=await f(g(m,u.POLLS)),a=[];o.forEach(s=>{a.push({id:s.id,...s.data()})}),document.getElementById("totalPolls").textContent=a.length;const n=await f(g(m,u.USERS));document.getElementById("totalUsers").textContent=n.size;try{const s=await f(g(m,u.VOTES));document.getElementById("totalVotes").textContent=s.size}catch{document.getElementById("totalVotes").textContent="0"}Fe(t),Ue(a)}catch(e){console.error("Error loading dashboard stats:",e),document.getElementById("totalElections").textContent="0",document.getElementById("totalPolls").textContent="0",document.getElementById("totalUsers").textContent="0",document.getElementById("totalVotes").textContent="0"}}function Fe(e){const t=document.getElementById("recentElectionsList");if(!t)return;if(e.length===0){t.innerHTML='<p class="no-data">No elections created yet</p>';return}e.sort((a,n)=>{var c,i;const s=(c=a.created_at)!=null&&c.toDate?a.created_at.toDate():new Date(a.start_date);return((i=n.created_at)!=null&&i.toDate?n.created_at.toDate():new Date(n.start_date))-s});let o='<div class="recent-items-grid">';e.slice(0,5).forEach(a=>{var r,d;const n=ye(a),s=(r=a.start_date)!=null&&r.toDate?a.start_date.toDate():new Date(a.start_date),l=(d=a.end_date)!=null&&d.toDate?a.end_date.toDate():new Date(a.end_date),c=n==="active"?"status-active":n==="scheduled"?"status-scheduled":"status-closed",i=n==="active"?"üî¥":n==="scheduled"?"üìÖ":"‚úÖ";o+=`
      <div class="recent-item-card">
        <div class="recent-item-header">
          <h4>${a.title}</h4>
          <span class="status-badge ${c}">${i} ${n.toUpperCase()}</span>
        </div>
        <div class="recent-item-meta">
          <span>üìÖ ${s.toLocaleDateString()} - ${l.toLocaleDateString()}</span>
          <span>üéØ ${a.faculty_scope_type||"All Faculties"}</span>
        </div>
      </div>
    `}),o+="</div>",t.innerHTML=o}function Ue(e){const t=document.getElementById("recentPollsList");if(!t)return;if(e.length===0){t.innerHTML='<p class="no-data">No polls created yet</p>';return}e.sort((a,n)=>{var c,i;const s=(c=a.created_at)!=null&&c.toDate?a.created_at.toDate():new Date(a.start_date);return((i=n.created_at)!=null&&i.toDate?n.created_at.toDate():new Date(n.start_date))-s});let o='<div class="recent-items-grid">';e.slice(0,5).forEach(a=>{var r,d;const n=ye(a),s=(r=a.start_date)!=null&&r.toDate?a.start_date.toDate():new Date(a.start_date),l=(d=a.end_date)!=null&&d.toDate?a.end_date.toDate():new Date(a.end_date),c=n==="active"?"status-active":n==="scheduled"?"status-scheduled":"status-closed",i=n==="active"?"üî¥":n==="scheduled"?"üìÖ":"‚úÖ";o+=`
      <div class="recent-item-card">
        <div class="recent-item-header">
          <h4>${a.title}</h4>
          <span class="status-badge ${c}">${i} ${n.toUpperCase()}</span>
        </div>
        <div class="recent-item-meta">
          <span>üìÖ ${s.toLocaleDateString()} - ${l.toLocaleDateString()}</span>
          <span>üéØ ${a.target_type||"All Faculties"}</span>
        </div>
      </div>
    `}),o+="</div>",t.innerHTML=o}const B={publicKey:"EPO61S4tPNKPKy6UH",serviceId:"service_ly8htul",templates:{welcome:"template_sghhqdn",notification:"template_notify",announcement:"template_announce",results:"template_results"}};function Y(){const e=localStorage.getItem("emailjs_settings");if(e){const t=JSON.parse(e);return{publicKey:t.publicKey||B.publicKey,serviceId:t.serviceId||B.serviceId,templates:{welcome:t.templateWelcome||B.templates.welcome,notification:t.templateNotify||B.templates.notification,announcement:t.templateAnnounce||B.templates.announcement,results:t.templateResults||B.templates.results}}}return B}const I={get publicKey(){return Y().publicKey},get serviceId(){return Y().serviceId},get templates(){return Y().templates}};let te=!1;async function $(){return te?!0:new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js",o.onload=()=>{window.emailjs?(window.emailjs.init(I.publicKey),te=!0,console.log("EmailJS initialized"),e(!0)):t(new Error("EmailJS failed to load"))},o.onerror=()=>t(new Error("Failed to load EmailJS SDK")),document.head.appendChild(o)})}async function ke(e){try{await $();const t={to_name:e.name,to_email:e.email,university_id:e.university_id,faculty:e.faculty,major:e.major,role:e.role,login_url:window.location.origin},o=await window.emailjs.send(I.serviceId,I.templates.welcome,t);return console.log("Welcome email sent:",o),{success:!0,response:o}}catch(t){return console.error("Failed to send welcome email:",t),{success:!1,error:t.message}}}async function ge(e,t){try{await $();const o=[];for(const a of e){if(!a.contact_email)continue;const n={to_name:a.name,to_email:a.contact_email,notification_type:t.type,title:t.title,description:t.description,start_date:t.startDate,end_date:t.endDate,action_url:window.location.origin};try{const s=await window.emailjs.send(I.serviceId,I.templates.notification,n);o.push({email:n.to_email,success:!0})}catch(s){o.push({email:n.to_email,success:!1,error:s.message})}await new Promise(s=>setTimeout(s,100))}return{success:!0,results:o}}catch(o){return console.error("Failed to send notifications:",o),{success:!1,error:o.message}}}async function Re(e,t){try{await $();const o=[];for(const a of e){if(!a.contact_email)continue;const n={to_name:a.name,to_email:a.contact_email,subject:t.subject,message:t.message,from_name:t.fromName||"University E-Voting Admin"};try{const s=await window.emailjs.send(I.serviceId,I.templates.announcement,n);o.push({email:n.to_email,success:!0})}catch(s){o.push({email:n.to_email,success:!1,error:s.message})}await new Promise(s=>setTimeout(s,100))}return{success:!0,results:o}}catch(o){return console.error("Failed to send announcement:",o),{success:!1,error:o.message}}}async function He(e,t){try{await $();const o=[];for(const a of e){if(!a.contact_email)continue;const n={to_name:a.name,to_email:a.contact_email,election_title:t.title,winner_name:t.winnerName,winner_votes:t.winnerVotes,total_votes:t.totalVotes,results_url:window.location.origin};try{const s=await window.emailjs.send(I.serviceId,I.templates.results,n);o.push({email:n.to_email,success:!0})}catch(s){o.push({email:n.to_email,success:!1,error:s.message})}await new Promise(s=>setTimeout(s,100))}return{success:!0,results:o}}catch(o){return console.error("Failed to send results:",o),{success:!1,error:o.message}}}function Ee(){return I.publicKey!=="YOUR_PUBLIC_KEY"&&I.serviceId!=="YOUR_SERVICE_ID"}let D=null;async function z(){const e=document.getElementById("usersList");e.innerHTML='<p class="loading">Loading users...</p>';try{const t=await f(g(m,u.USERS));if(t.empty){e.innerHTML='<p class="loading">No users found</p>';return}const o=[];t.forEach(n=>{o.push({id:n.id,...n.data()})}),o.sort((n,s)=>n.name&&s.name?n.name.localeCompare(s.name):0);let a="<table><thead><tr><th>Name</th><th>University ID</th><th>Faculty</th><th>Major</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>";o.forEach(n=>{a+=`
        <tr>
          <td>${n.name||"N/A"}</td>
          <td>${n.university_id||"N/A"}</td>
          <td>${n.faculty||"N/A"}</td>
          <td>${n.major||"N/A"}</td>
          <td><span class="badge ${n.role==="admin"?"badge-scheduled":"badge-active"}">${n.role||"N/A"}</span></td>
          <td><span class="badge ${n.is_active?"badge-active":"badge-inactive"}">${n.is_active?"Active":"Inactive"}</span></td>
          <td>
            <button class="btn btn-secondary" onclick="editUser('${n.id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteUser('${n.id}')">Delete</button>
          </td>
        </tr>
      `}),a+="</tbody></table>",e.innerHTML=a}catch(t){console.error("Error loading users:",t),e.innerHTML=`<p class="error-message">Error loading users: ${t.message}</p>`}}function fe(){D=null,document.getElementById("userModalTitle").textContent="Add User",document.getElementById("userForm").reset(),document.getElementById("editUserId").value="",document.getElementById("userPassword").required=!0,document.getElementById("passwordHint").textContent="Required for new users (min 6 characters)",document.getElementById("userUniversityId").disabled=!1,document.getElementById("userError").textContent="",document.getElementById("userModal").style.display="flex"}function Q(){document.getElementById("userModal").style.display="none",document.getElementById("userForm").reset(),D=null}window.editUser=async function(e){try{const t=await P(v(m,u.USERS,e));if(!t.exists()){alert("User not found");return}const o=t.data();D=e,document.getElementById("userModalTitle").textContent="Edit User",document.getElementById("editUserId").value=e,document.getElementById("userName").value=o.name||"",document.getElementById("userUniversityId").value=o.university_id||"",document.getElementById("userUniversityId").disabled=!0,document.getElementById("userContactEmail").value=o.contact_email||"",document.getElementById("userPassword").value="",document.getElementById("userPassword").required=!1,document.getElementById("passwordHint").textContent="Leave blank to keep current password",document.getElementById("userFaculty").value=o.faculty||"",document.getElementById("userMajor").value=o.major||"",document.getElementById("userRole").value=o.role||"voter",document.getElementById("userStatus").value=o.is_active?"true":"false",document.getElementById("userError").textContent="",document.getElementById("userModal").style.display="flex"}catch(t){console.error("Error loading user:",t),alert("Error loading user data")}};window.deleteUser=async function(e){if(confirm("Are you sure you want to delete this user? This will only remove the user data, not the authentication account."))try{await C(v(m,u.USERS,e)),alert("User deleted successfully"),z()}catch(t){console.error("Error deleting user:",t),alert("Error deleting user: "+t.message)}};async function qe(e){e.preventDefault();const t=document.getElementById("userError"),o=document.getElementById("saveUserBtn"),a=document.getElementById("userName").value.trim(),n=document.getElementById("userUniversityId").value.trim().toUpperCase(),s=document.getElementById("userContactEmail").value.trim().toLowerCase(),l=document.getElementById("userPassword").value,c=document.getElementById("userFaculty").value,i=document.getElementById("userMajor").value.trim(),r=document.getElementById("userRole").value,d=document.getElementById("userStatus").value==="true";if(!a||!n||!s||!c||!i){t.textContent="Please fill in all required fields";return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)){t.textContent="Please enter a valid contact email";return}if(!D&&(!l||l.length<6)){t.textContent="Password must be at least 6 characters for new users";return}o.disabled=!0,o.textContent="Saving...",t.textContent="";try{if(D)await V(v(m,u.USERS,D),{name:a,contact_email:s,faculty:c,major:i,role:r,is_active:d,updated_at:h.now()}),alert("User updated successfully!");else{const y=`${n.toLowerCase()}@university.edu`,L=me({apiKey:"AIzaSyApJ-yf788oQncbo2p3E0V9BMAyLEhY_cY",authDomain:"universityevoting2.firebaseapp.com",projectId:"universityevoting2",storageBucket:"universityevoting2.firebasestorage.app",messagingSenderId:"681736971312",appId:"1:681736971312:web:51ff23b2ce275e461ff9f5"},"SecondaryApp"),w=pe(L);try{const ee=(await Ce(w,y,l)).user.uid;await U(w),await xe(v(m,u.USERS,ee),{user_id:ee,university_id:n,contact_email:s,name:a,faculty:c,major:i,role:r,is_active:d,photo_url:null,created_at:h.now()});let O="";if(Ee())try{await ke({name:a,email:s,university_id:n,faculty:c,major:i,role:r}),O=`
Welcome email sent to `+s+"!"}catch(Se){console.warn("Failed to send welcome email:",Se),O=`
(Welcome email not sent - check email configuration)`}else O=`
(Email not configured - no welcome email sent)`;alert(`User created successfully!
Login email: `+y+`
Contact email: `+s+O)}finally{await Le(L)}}Q(),z()}catch(y){console.error("Error saving user:",y);let E="Error saving user";y.code==="auth/email-already-in-use"?E="A user with this University ID already exists":y.code==="auth/weak-password"?E="Password is too weak (min 6 characters)":y.code==="auth/invalid-email"?E="Invalid University ID format":E=y.message,t.textContent=E}finally{o.disabled=!1,o.textContent="Save User"}}window.openUserModal=fe;window.closeUserModal=Q;document.addEventListener("DOMContentLoaded",()=>{var e,t,o;(e=document.getElementById("createUserBtn"))==null||e.addEventListener("click",fe),(t=document.getElementById("userForm"))==null||t.addEventListener("submit",qe),(o=document.getElementById("userModal"))==null||o.addEventListener("click",a=>{a.target.id==="userModal"&&Q()})});let M=null;async function R(){const e=document.getElementById("electionsList");e.innerHTML='<p class="loading">Loading elections...</p>';try{const t=await f(g(m,u.ELECTIONS));if(t.empty){e.innerHTML='<p class="loading">No elections found</p>';return}let o="";t.forEach(a=>{var c,i;const n=a.data(),s=(c=n.start_date)!=null&&c.toDate?n.start_date.toDate():new Date(n.start_date),l=(i=n.end_date)!=null&&i.toDate?n.end_date.toDate():new Date(n.end_date);o+=`
        <div class="list-item">
          <div>
            <div class="list-item-title">${n.title}</div>
            <div class="list-item-subtitle">
              ${n.description||"No description"}<br>
              Start: ${s.toLocaleDateString()} - End: ${l.toLocaleDateString()}<br>
              Faculty Scope: ${n.faculty_scope_type}
            </div>
          </div>
          <div>
            <span class="badge badge-${Ve(n.status)}">${n.status}</span>
            <div class="list-item-actions">
              <button class="btn btn-secondary" onclick="editElection('${a.id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteElection('${a.id}')">Delete</button>
            </div>
          </div>
        </div>
      `}),e.innerHTML=o}catch(t){console.error("Error loading elections:",t),e.innerHTML='<p class="error-message">Error loading elections</p>'}}function Ve(e){switch(e){case"active":return"active";case"scheduled":return"scheduled";case"closed":return"closed";case"draft":return"draft";default:return"inactive"}}function ne(e){const t=new Date(e),o=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0");return`${o}-${a}-${n}T${s}:${l}`}window.editElection=async function(e){var t,o;try{const a=document.getElementById("electionModal"),n=document.getElementById("electionModalTitle"),s=await P(v(m,u.ELECTIONS,e));if(!s.exists()){alert("Election not found");return}const l=s.data();M=e,n.textContent="Edit Election",document.getElementById("electionTitle").value=l.title||"",document.getElementById("electionDescription").value=l.description||"",document.getElementById("electionScopeType").value=l.faculty_scope_type||"",document.getElementById("electionStatus").value=l.status||"draft";const c=(t=l.start_date)!=null&&t.toDate?l.start_date.toDate():new Date(l.start_date),i=(o=l.end_date)!=null&&o.toDate?l.end_date.toDate():new Date(l.end_date);document.getElementById("electionStartDate").value=ne(c),document.getElementById("electionEndDate").value=ne(i);const r=l.faculty_scope_type,d=document.getElementById("facultyScopeGroup");r==="SINGLE_FACULTY"||r==="MULTI_FACULTY"?(d.style.display="block",document.querySelectorAll('#facultyCheckboxes input[type="checkbox"]').forEach(y=>y.checked=!1),l.faculty_scope&&Array.isArray(l.faculty_scope)&&l.faculty_scope.forEach(y=>{const E=document.querySelector(`#facultyCheckboxes input[value="${y}"]`);E&&(E.checked=!0)})):d.style.display="none",document.getElementById("electionError").textContent="",a.classList.add("active")}catch(a){console.error("Error loading election for edit:",a),alert("Error loading election: "+a.message)}};window.deleteElection=async function(e){if(confirm("Are you sure you want to delete this election? This action cannot be undone."))try{await C(v(m,u.ELECTIONS,e)),alert("Election deleted successfully"),R()}catch(t){console.error("Error deleting election:",t),alert("Error deleting election")}};window.openElectionModal=function(){M=null,document.getElementById("electionModalTitle").textContent="Create Election",document.getElementById("electionForm").reset(),document.getElementById("facultyScopeGroup").style.display="none",document.getElementById("electionError").textContent="",document.getElementById("electionModal").classList.add("active")};window.closeElectionModal=function(){document.getElementById("electionModal").classList.remove("active"),document.getElementById("electionForm").reset(),document.getElementById("facultyScopeGroup").style.display="none",document.getElementById("electionError").textContent="",M=null};window.toggleFacultySelect=function(){const e=document.getElementById("electionScopeType").value,t=document.getElementById("facultyScopeGroup");e==="SINGLE_FACULTY"||e==="MULTI_FACULTY"?t.style.display="block":t.style.display="none"};var le;(le=document.getElementById("electionForm"))==null||le.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("electionTitle").value.trim(),o=document.getElementById("electionDescription").value.trim(),a=document.getElementById("electionScopeType").value,n=new Date(document.getElementById("electionStartDate").value),s=new Date(document.getElementById("electionEndDate").value),l=document.getElementById("electionStatus").value;if(!t){document.getElementById("electionError").textContent="Please enter a title";return}if(!a){document.getElementById("electionError").textContent="Please select a faculty scope type";return}if(s<=n){document.getElementById("electionError").textContent="End date must be after start date";return}let c=[];if(a!=="ALL_FACULTIES"){const r=document.querySelectorAll("#facultyCheckboxes input:checked");if(c=Array.from(r).map(d=>d.value),c.length===0){document.getElementById("electionError").textContent="Please select at least one faculty";return}}const i={title:t,description:o,faculty_scope_type:a,faculty_scope:c,start_date:h.fromDate(n),end_date:h.fromDate(s),status:l,updated_at:h.now()};try{M?(await V(v(m,u.ELECTIONS,M),i),closeElectionModal(),R(),alert("Election updated successfully!")):(i.created_at=h.now(),await x(g(m,u.ELECTIONS),i),closeElectionModal(),R(),alert("Election created successfully!"))}catch(r){console.error("Error saving election:",r),document.getElementById("electionError").textContent="Error saving election: "+r.message}});var ie;(ie=document.getElementById("createElectionBtn"))==null||ie.addEventListener("click",openElectionModal);let N=null;async function H(){const e=document.getElementById("candidatesList");e.innerHTML='<p class="loading">Loading candidates...</p>';try{const t=await f(g(m,u.CANDIDATES));if(t.empty){e.innerHTML='<p class="loading">No candidates found</p>';return}let o="<table><thead><tr><th>Name</th><th>Faculty</th><th>Election ID</th><th>Bio</th><th>Actions</th></tr></thead><tbody>";t.forEach(a=>{const n=a.data(),s=n.bio?n.bio.substring(0,50)+"...":"N/A";o+=`
        <tr>
          <td>${n.name}</td>
          <td>${n.faculty}</td>
          <td>${n.election_id}</td>
          <td>${s}</td>
          <td>
            <button class="btn btn-secondary" onclick="editCandidate('${a.id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteCandidate('${a.id}')">Delete</button>
          </td>
        </tr>
      `}),o+="</tbody></table>",e.innerHTML=o}catch(t){console.error("Error loading candidates:",t),e.innerHTML='<p class="error-message">Error loading candidates</p>'}}async function ve(){try{const e=await f(g(m,u.ELECTIONS)),t=document.getElementById("candidateElection");return t.innerHTML='<option value="">Select election...</option>',e.forEach(o=>{const a=o.data(),n=document.createElement("option");n.value=o.id,n.textContent=a.title,t.appendChild(n)}),!0}catch(e){return console.error("Error loading elections:",e),!1}}window.editCandidate=async function(e){try{const t=await P(v(m,u.CANDIDATES,e));if(!t.exists()){alert("Candidate not found");return}const o=t.data();N=e;const a=document.querySelector("#candidateModal .modal-header h2");a&&(a.textContent="Edit Candidate"),await ve(),document.getElementById("candidateName").value=o.name||"",document.getElementById("candidateElection").value=o.election_id||"",document.getElementById("candidateFaculty").value=o.faculty||"",document.getElementById("candidateBio").value=o.bio||"",document.getElementById("candidateError").textContent="",document.getElementById("candidateModal").classList.add("active")}catch(t){console.error("Error loading candidate for edit:",t),alert("Error loading candidate: "+t.message)}};window.deleteCandidate=async function(e){if(confirm("Are you sure you want to delete this candidate? This action cannot be undone."))try{await C(v(m,u.CANDIDATES,e)),alert("Candidate deleted successfully"),H()}catch(t){console.error("Error deleting candidate:",t),alert("Error deleting candidate")}};window.openCandidateModal=async function(){N=null;const e=document.querySelector("#candidateModal .modal-header h2");e&&(e.textContent="Add Candidate"),document.getElementById("candidateForm").reset(),document.getElementById("candidateError").textContent="",await ve(),document.getElementById("candidateModal").classList.add("active")};window.closeCandidateModal=function(){document.getElementById("candidateModal").classList.remove("active"),document.getElementById("candidateForm").reset(),document.getElementById("candidateError").textContent="",N=null};var ce;(ce=document.getElementById("candidateForm"))==null||ce.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("candidateName").value.trim(),o=document.getElementById("candidateElection").value,a=document.getElementById("candidateFaculty").value,n=document.getElementById("candidateBio").value.trim();if(!t){document.getElementById("candidateError").textContent="Please enter a name";return}if(!o){document.getElementById("candidateError").textContent="Please select an election";return}if(!a){document.getElementById("candidateError").textContent="Please select a faculty";return}const s={name:t,election_id:o,faculty:a,bio:n,updated_at:h.now()};try{N?(await V(v(m,u.CANDIDATES,N),s),closeCandidateModal(),H(),alert("Candidate updated successfully!")):(s.photo_url=null,s.created_at=h.now(),await x(g(m,u.CANDIDATES),s),closeCandidateModal(),H(),alert("Candidate added successfully!"))}catch(l){console.error("Error saving candidate:",l),document.getElementById("candidateError").textContent="Error saving candidate: "+l.message}});var re;(re=document.getElementById("createCandidateBtn"))==null||re.addEventListener("click",openCandidateModal);let S=null;async function q(){const e=document.getElementById("pollsList");e.innerHTML='<p class="loading">Loading polls...</p>';try{const t=await f(g(m,u.POLLS));if(t.empty){e.innerHTML='<p class="loading">No polls found</p>';return}let o="";t.forEach(a=>{var c,i;const n=a.data(),s=(c=n.start_date)!=null&&c.toDate?n.start_date.toDate():new Date(n.start_date),l=(i=n.end_date)!=null&&i.toDate?n.end_date.toDate():new Date(n.end_date);o+=`
        <div class="list-item">
          <div>
            <div class="list-item-title">${n.title}</div>
            <div class="list-item-subtitle">
              ${n.description||"No description"}<br>
              Start: ${s.toLocaleDateString()} - End: ${l.toLocaleDateString()}<br>
              Target: ${n.target_type}
            </div>
          </div>
          <div>
            <span class="badge badge-${je(n.status)}">${n.status}</span>
            <div class="list-item-actions">
              <button class="btn btn-secondary" onclick="editPoll('${a.id}')">Edit</button>
              <button class="btn btn-danger" onclick="deletePoll('${a.id}')">Delete</button>
            </div>
          </div>
        </div>
      `}),e.innerHTML=o}catch(t){console.error("Error loading polls:",t),e.innerHTML='<p class="error-message">Error loading polls</p>'}}function je(e){switch(e){case"active":return"active";case"scheduled":return"scheduled";case"closed":return"closed";case"draft":return"draft";default:return"inactive"}}function oe(e){const t=new Date(e),o=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0");return`${o}-${a}-${n}T${s}:${l}`}window.editPoll=async function(e){var t,o;try{const a=await P(v(m,u.POLLS,e));if(!a.exists()){alert("Poll not found");return}const n=a.data();S=e;const s=document.querySelector("#pollModal .modal-header h2");s&&(s.textContent="Edit Poll"),document.getElementById("pollTitle").value=n.title||"",document.getElementById("pollDescription").value=n.description||"",document.getElementById("pollTargetType").value=n.target_type||"",document.getElementById("pollStatus").value=n.status||"draft";const l=(t=n.start_date)!=null&&t.toDate?n.start_date.toDate():new Date(n.start_date),c=(o=n.end_date)!=null&&o.toDate?n.end_date.toDate():new Date(n.end_date);document.getElementById("pollStartDate").value=oe(l),document.getElementById("pollEndDate").value=oe(c);const i=n.target_type,r=document.getElementById("pollFacultyScopeGroup");i==="SINGLE_FACULTY"||i==="MULTI_FACULTY"?(r.style.display="block",document.querySelectorAll('#pollFacultyCheckboxes input[type="checkbox"]').forEach(y=>y.checked=!1),n.target_faculties&&Array.isArray(n.target_faculties)&&n.target_faculties.forEach(y=>{const E=document.querySelector(`#pollFacultyCheckboxes input[value="${y}"]`);E&&(E.checked=!0)})):r.style.display="none";const d=document.getElementById("pollOptionsContainer");d.innerHTML="";try{const p=await f(j(g(m,u.POLL_OPTIONS),K("poll_id","==",e)));if(p.empty)d.innerHTML=`
          <input type="text" class="poll-option" placeholder="Option 1" required>
          <input type="text" class="poll-option" placeholder="Option 2" required>
        `;else{const y=[];p.forEach(E=>{y.push({id:E.id,...E.data()})}),y.sort((E,L)=>(E.order||0)-(L.order||0)),y.forEach((E,L)=>{const w=document.createElement("input");w.type="text",w.className="poll-option",w.placeholder=`Option ${L+1}`,w.required=!0,w.value=E.text||"",w.dataset.optionId=E.id,d.appendChild(w)})}}catch(p){console.error("Error loading poll options:",p),d.innerHTML=`
        <input type="text" class="poll-option" placeholder="Option 1" required>
        <input type="text" class="poll-option" placeholder="Option 2" required>
      `}document.getElementById("pollError").textContent="",document.getElementById("pollModal").classList.add("active")}catch(a){console.error("Error loading poll for edit:",a),alert("Error loading poll: "+a.message)}};window.deletePoll=async function(e){if(confirm("Are you sure you want to delete this poll? This will also delete all poll options and votes."))try{const t=await f(j(g(m,u.POLL_OPTIONS),K("poll_id","==",e))),o=[];t.forEach(a=>{o.push(C(v(m,u.POLL_OPTIONS,a.id)))}),await Promise.all(o),await C(v(m,u.POLLS,e)),alert("Poll deleted successfully"),q()}catch(t){console.error("Error deleting poll:",t),alert("Error deleting poll")}};window.openPollModal=function(){S=null;const e=document.querySelector("#pollModal .modal-header h2");e&&(e.textContent="Create Poll"),document.getElementById("pollForm").reset(),document.getElementById("pollFacultyScopeGroup").style.display="none",document.getElementById("pollError").textContent="",document.getElementById("pollOptionsContainer").innerHTML=`
    <input type="text" class="poll-option" placeholder="Option 1" required>
    <input type="text" class="poll-option" placeholder="Option 2" required>
  `,document.getElementById("pollModal").classList.add("active")};window.closePollModal=function(){document.getElementById("pollModal").classList.remove("active"),document.getElementById("pollForm").reset(),document.getElementById("pollFacultyScopeGroup").style.display="none",document.getElementById("pollError").textContent="",S=null,document.getElementById("pollOptionsContainer").innerHTML=`
    <input type="text" class="poll-option" placeholder="Option 1" required>
    <input type="text" class="poll-option" placeholder="Option 2" required>
  `};window.togglePollFacultySelect=function(){const e=document.getElementById("pollTargetType").value,t=document.getElementById("pollFacultyScopeGroup");e==="SINGLE_FACULTY"||e==="MULTI_FACULTY"?t.style.display="block":t.style.display="none"};window.addPollOption=function(){const e=document.getElementById("pollOptionsContainer"),t=e.querySelectorAll(".poll-option").length+1,o=document.createElement("input");o.type="text",o.className="poll-option",o.placeholder=`Option ${t}`,o.required=!0,e.appendChild(o)};var de;(de=document.getElementById("pollForm"))==null||de.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("pollTitle").value.trim(),o=document.getElementById("pollDescription").value.trim(),a=document.getElementById("pollTargetType").value,n=new Date(document.getElementById("pollStartDate").value),s=new Date(document.getElementById("pollEndDate").value),l=document.getElementById("pollStatus").value;if(!t){document.getElementById("pollError").textContent="Please enter a poll question";return}if(!a){document.getElementById("pollError").textContent="Please select a target type";return}if(s<=n){document.getElementById("pollError").textContent="End date must be after start date";return}let c=[];if(a!=="ALL_FACULTIES"){const p=document.querySelectorAll("#pollFacultyCheckboxes input:checked");if(c=Array.from(p).map(y=>y.value),c.length===0){document.getElementById("pollError").textContent="Please select at least one faculty";return}}const i=document.querySelectorAll(".poll-option"),r=Array.from(i).map(p=>({text:p.value.trim(),id:p.dataset.optionId||null})).filter(p=>p.text);if(r.length<2){document.getElementById("pollError").textContent="Please provide at least 2 options";return}const d={title:t,description:o,target_type:a,target_faculties:c,start_date:h.fromDate(n),end_date:h.fromDate(s),status:l,updated_at:h.now()};try{if(S){await V(v(m,u.POLLS,S),d);const p=await f(j(g(m,u.POLL_OPTIONS),K("poll_id","==",S))),y=[];p.forEach(E=>{y.push(C(v(m,u.POLL_OPTIONS,E.id)))}),await Promise.all(y);for(let E=0;E<r.length;E++)await x(g(m,u.POLL_OPTIONS),{poll_id:S,text:r[E].text,order:E});closePollModal(),q(),alert("Poll updated successfully!")}else{d.created_at=h.now();const p=await x(g(m,u.POLLS),d);for(let y=0;y<r.length;y++)await x(g(m,u.POLL_OPTIONS),{poll_id:p.id,text:r[y].text,order:y});closePollModal(),q(),alert("Poll created successfully!")}}catch(p){console.error("Error saving poll:",p),document.getElementById("pollError").textContent="Error saving poll: "+p.message}});var ue;(ue=document.getElementById("createPollBtn"))==null||ue.addEventListener("click",openPollModal);let ae=[],_=null;function he(e){document.querySelectorAll(".results-tab").forEach(o=>{o.classList.remove("active"),o.dataset.tab===e&&o.classList.add("active")}),document.querySelectorAll(".results-tab-content").forEach(o=>{o.classList.remove("active")});const t=document.getElementById(`${e}-tab`);t&&t.classList.add("active")}window.switchResultsTab=he;function Ie(){console.log("Initializing Results Page..."),he("active-elections"),X(),Ke()}function Ke(){_&&clearInterval(_),_=setInterval(()=>{X()},3e4)}function Ge(){_&&(clearInterval(_),_=null)}function We(){ae.forEach(e=>e()),ae=[]}async function X(){console.log("Loading all results...");try{await Promise.all([Je(),ze(),Qe(),Ye()]),console.log("All results loaded successfully")}catch(e){console.error("Error loading results:",e)}}function A(e){var n,s;const t=new Date,o=(n=e.start_date)!=null&&n.toDate?e.start_date.toDate():new Date(e.start_date),a=(s=e.end_date)!=null&&s.toDate?e.end_date.toDate():new Date(e.end_date);return t<o?"scheduled":t>=o&&t<=a?"active":"closed"}function b(e){const t=document.getElementById(e);t&&(t.textContent=`Updated: ${new Date().toLocaleTimeString()}`)}async function Ye(){try{const e=await f(g(m,u.ELECTIONS));let t=0;e.forEach(d=>{d.data().status==="active"&&t++});const o=document.getElementById("activeElectionsCount");o&&(o.textContent=t);const a=await f(g(m,u.POLLS));let n=0;a.forEach(d=>{d.data().status==="active"&&n++});const s=document.getElementById("activePollsCount");s&&(s.textContent=n);const l=await f(g(m,u.VOTES)),c=document.getElementById("totalVotesCast");c&&(c.textContent=l.size);const i=new Set;l.forEach(d=>{const p=d.data();p.user_id&&i.add(p.user_id)});const r=document.getElementById("totalParticipants");r&&(r.textContent=i.size)}catch(e){console.error("Error loading stats:",e)}}async function Je(){const e=document.getElementById("activeElectionsList");if(!e){console.warn("activeElectionsList container not found");return}e.innerHTML='<p class="loading">Loading active elections...</p>';try{const t=await f(g(m,u.ELECTIONS)),o=[];if(t.forEach(n=>{const s=n.data(),l=A(s);(l==="active"||l==="scheduled")&&o.push({id:n.id,...s,actualStatus:l})}),console.log(`Found ${o.length} active/scheduled elections`),o.length===0){e.innerHTML=`
        <div class="no-results">
          <div class="no-results-icon">üó≥Ô∏è</div>
          <h4>No Active Elections</h4>
          <p>There are no elections currently in progress.</p>
        </div>
      `,b("activeElectionsUpdateTime");return}let a="";for(const n of o){const s=await we(n.id);a+=Be(n,s,!0)}e.innerHTML=a,b("activeElectionsUpdateTime")}catch(t){console.error("Error loading active elections:",t),e.innerHTML='<p class="error-message">Error loading active elections</p>'}}async function ze(){const e=document.getElementById("closedElectionsList");if(!e){console.warn("closedElectionsList container not found");return}e.innerHTML='<p class="loading">Loading closed elections...</p>';try{const t=await f(g(m,u.ELECTIONS)),o=[];if(t.forEach(n=>{const s=n.data(),l=A(s);l==="closed"&&o.push({id:n.id,...s,actualStatus:l})}),console.log(`Found ${o.length} closed elections`),o.length===0){e.innerHTML=`
        <div class="no-results">
          <div class="no-results-icon">‚úÖ</div>
          <h4>No Closed Elections</h4>
          <p>Completed elections will appear here.</p>
        </div>
      `,b("closedElectionsUpdateTime");return}let a="";for(const n of o){const s=await we(n.id);a+=Be(n,s,!1)}e.innerHTML=a,b("closedElectionsUpdateTime")}catch(t){console.error("Error loading closed elections:",t),e.innerHTML='<p class="error-message">Error loading closed elections</p>'}}async function we(e){const t={candidates:[],totalVotes:0};try{const o=await f(g(m,u.VOTES)),a={};o.forEach(s=>{const l=s.data();l.election_id===e&&(a[l.candidate_id]=(a[l.candidate_id]||0)+1,t.totalVotes++)}),(await f(g(m,u.CANDIDATES))).forEach(s=>{const l=s.data();if(l.election_id===e){const c=a[s.id]||0,i=t.totalVotes>0?c/t.totalVotes*100:0;t.candidates.push({id:s.id,name:l.name,faculty:l.faculty,bio:l.bio,votes:c,percentage:i})}}),t.candidates.sort((s,l)=>l.votes-s.votes)}catch(o){console.error("Error getting election results:",o)}return t}function Be(e,t,o){var i,r;const a=(i=e.start_date)!=null&&i.toDate?e.start_date.toDate():new Date(e.start_date),n=(r=e.end_date)!=null&&r.toDate?e.end_date.toDate():new Date(e.end_date),s=e.actualStatus||A(e),l=o&&s==="active"?'<span class="badge badge-active">üî¥ LIVE</span>':`<span class="badge badge-${s}">${s}</span>`;let c="";return t.candidates.length===0?c='<p class="loading" style="text-align: center; padding: 20px;">No candidates registered</p>':t.candidates.forEach((d,p)=>{const y=p===0&&t.totalVotes>0;c+=`
        <div class="candidate-result-item ${y&&!o?"winner":""}">
          <div class="candidate-rank">${p+1}</div>
          <div class="candidate-info">
            <div class="candidate-name">
              ${d.name}
              ${y&&!o?'<span class="winner-badge">üèÜ Winner</span>':""}
            </div>
            <div class="candidate-faculty">${d.faculty}</div>
          </div>
          <div class="candidate-votes-section">
            <div class="vote-progress-container">
              <div class="vote-progress-bar" style="width: ${d.percentage}%"></div>
            </div>
            <div class="candidate-vote-count">
              <div class="vote-number">${d.votes}</div>
              <div class="vote-percentage">${d.percentage.toFixed(1)}%</div>
            </div>
          </div>
        </div>
      `}),`
    <div class="election-result-card ${o&&s==="active"?"live":""}">
      <div class="election-card-header">
        <div class="election-card-info">
          <h4>${e.title}</h4>
          <div class="election-card-meta">
            <span>üìÖ ${a.toLocaleDateString()} - ${n.toLocaleDateString()}</span>
            <span>üéØ ${e.faculty_scope_type||"All"}</span>
            ${l}
          </div>
        </div>
        <div class="election-card-stats">
          <div class="election-stat">
            <div class="election-stat-value">${t.totalVotes}</div>
            <div class="election-stat-label">Total Votes</div>
          </div>
          <div class="election-stat">
            <div class="election-stat-value">${t.candidates.length}</div>
            <div class="election-stat-label">Candidates</div>
          </div>
        </div>
      </div>
      <div class="candidates-results-list">
        ${c}
      </div>
    </div>
  `}async function Qe(){const e=document.getElementById("pollResultsList");if(!e){console.warn("pollResultsList container not found");return}e.innerHTML='<p class="loading">Loading poll results...</p>';try{const t=await f(g(m,u.POLLS));if(t.empty){e.innerHTML=`
        <div class="no-results">
          <div class="no-results-icon">üìä</div>
          <h4>No Polls</h4>
          <p>Poll results will appear here.</p>
        </div>
      `,b("pollsUpdateTime");return}let o="";const a=[];t.forEach(n=>{const s=n.data(),l=A(s);a.push({id:n.id,...s,actualStatus:l})}),console.log(`Found ${a.length} polls`);for(const n of a){const s=await Xe(n.id);o+=Ze(n,s)}e.innerHTML=o||`
      <div class="no-results">
        <div class="no-results-icon">üìä</div>
        <h4>No Polls</h4>
        <p>Poll results will appear here.</p>
      </div>
    `,b("pollsUpdateTime")}catch(t){console.error("Error loading polls:",t),e.innerHTML='<p class="error-message">Error loading poll results</p>'}}async function Xe(e){const t={options:[],totalVotes:0};try{const o=await f(g(m,u.POLL_OPTIONS)),a=[];o.forEach(l=>{const c=l.data();c.poll_id===e&&a.push({id:l.id,...c})}),a.sort((l,c)=>(l.order||0)-(c.order||0));const n=await f(g(m,u.POLL_VOTES)),s={};if(n.forEach(l=>{const c=l.data();c.poll_id===e&&(s[c.option_id]=(s[c.option_id]||0)+1,t.totalVotes++)}),a.forEach(l=>{const c=s[l.id]||0,i=t.totalVotes>0?c/t.totalVotes*100:0;t.options.push({id:l.id,text:l.text,votes:c,percentage:i})}),t.options.length>0){const l=Math.max(...t.options.map(c=>c.votes));l>0&&t.options.forEach(c=>{c.isWinner=c.votes===l})}}catch(o){console.error("Error getting poll results:",o)}return t}function Ze(e,t){var l,c;const o=(l=e.start_date)!=null&&l.toDate?e.start_date.toDate():new Date(e.start_date),a=(c=e.end_date)!=null&&c.toDate?e.end_date.toDate():new Date(e.end_date),n=e.actualStatus||A(e);let s="";return t.options.length===0?s='<p class="loading" style="text-align: center;">No options available</p>':t.options.forEach(i=>{const r=Math.max(i.percentage,i.votes>0?8:0);s+=`
        <div class="poll-option-item ${i.isWinner?"winner":""}">
          <div class="poll-option-header">
            <span class="poll-option-text">${i.text} ${i.isWinner?"üèÜ":""}</span>
            <span class="poll-option-votes">${i.votes} votes</span>
          </div>
          <div class="poll-option-bar">
            <div class="poll-option-fill" style="width: ${r}%">
              ${i.percentage>0?`<span>${i.percentage.toFixed(1)}%</span>`:""}
            </div>
          </div>
        </div>
      `}),`
    <div class="poll-result-card">
      <div class="poll-card-header">
        <h4>${e.title}</h4>
        <div class="poll-card-meta">
          <span>üìÖ ${o.toLocaleDateString()} - ${a.toLocaleDateString()}</span>
          <span>üéØ ${e.target_type||"All"}</span>
          <span class="badge badge-${n}">${n}</span>
          <span>üìä ${t.totalVotes} total votes</span>
        </div>
      </div>
      <div class="poll-options-list">
        ${s}
      </div>
    </div>
  `}window.refreshAllResults=function(){const e=document.getElementById("refreshResultsBtn");e&&(e.disabled=!0,e.innerHTML="‚è≥ Refreshing..."),X().then(()=>{e&&(e.disabled=!1,e.innerHTML="üîÑ Refresh")})};const et=new MutationObserver(e=>{e.forEach(t=>{t.target.id==="resultsPage"&&(t.target.classList.contains("active")?Ie():(Ge(),We()))})}),se=document.getElementById("resultsPage");se&&et.observe(se,{attributes:!0,attributeFilter:["class"]});async function Z(){const e=document.getElementById("emailConfigStatus");if(!e)return;Ee()?(e.innerHTML=`
      <div class="config-ok">
        <span class="status-icon">‚úÖ</span>
        <span>Email service is configured and ready</span>
      </div>
    `,e.className="config-status config-ok"):(e.innerHTML=`
      <div class="config-warning">
        <span class="status-icon">‚ö†Ô∏è</span>
        <span>Email service not configured. Click "Configure" to set up EmailJS.</span>
      </div>
    `,e.className="config-status config-warning")}async function G(){const e=await f(g(m,u.USERS)),t=[];return e.forEach(o=>{t.push({id:o.id,...o.data()})}),t}async function tt(e,t=null){let o=await G();switch(e){case"voters":return o.filter(a=>a.role==="voter");case"admins":return o.filter(a=>a.role==="admin");case"faculty":return o.filter(a=>a.faculty===t);case"all":default:return o}}window.openAnnouncementModal=function(){document.getElementById("announcementForm").reset(),document.getElementById("announcementError").textContent="",document.getElementById("announcementSuccess").style.display="none",document.getElementById("announcementFacultyGroup").style.display="none",document.getElementById("announcementModal").style.display="flex",document.getElementById("announcementTarget").addEventListener("change",function(){document.getElementById("announcementFacultyGroup").style.display=this.value==="faculty"?"block":"none"})};window.closeAnnouncementModal=function(){document.getElementById("announcementModal").style.display="none"};async function nt(e){e.preventDefault();const t=document.getElementById("sendAnnouncementBtn"),o=document.getElementById("announcementError"),a=document.getElementById("announcementSuccess"),n=document.getElementById("announcementSubject").value.trim(),s=document.getElementById("announcementMessage").value.trim(),l=document.getElementById("announcementTarget").value,c=document.getElementById("announcementFaculty").value;if(!n||!s){o.textContent="Please fill in all required fields";return}t.disabled=!0,t.textContent="Sending...",o.textContent="",a.style.display="none";try{const i=await tt(l,c);if(i.length===0){o.textContent="No recipients found for the selected filter";return}const r=await Re(i,{subject:n,message:s,fromName:"University E-Voting Admin"});if(r.success){const d=r.results.filter(p=>p.success).length;a.textContent=`Announcement sent to ${d}/${i.length} recipients`,a.style.display="block",document.getElementById("announcementForm").reset()}else o.textContent=r.error||"Failed to send announcement"}catch(i){console.error("Error sending announcement:",i),o.textContent=i.message}finally{t.disabled=!1,t.textContent="Send Announcement"}}window.openPasswordResetModal=function(){document.getElementById("passwordResetForm").reset(),document.getElementById("resetError").textContent="",document.getElementById("resetSuccess").style.display="none",document.getElementById("passwordResetModal").style.display="flex"};window.closePasswordResetModal=function(){document.getElementById("passwordResetModal").style.display="none"};async function ot(e){e.preventDefault();const t=document.getElementById("sendResetBtn"),o=document.getElementById("resetError"),a=document.getElementById("resetSuccess"),n=document.getElementById("resetUniversityId").value.trim().toUpperCase();if(!n){o.textContent="Please enter a University ID";return}t.disabled=!0,t.textContent="Sending...",o.textContent="",a.style.display="none";try{const s=j(g(m,u.USERS),K("university_id","==",n)),l=await f(s);if(l.empty){o.textContent="No user found with this University ID";return}const c=l.docs[0].data(),i=c.contact_email;if(!i){o.textContent="No contact email found for this user";return}const r=JSON.parse(localStorage.getItem("emailjs_settings")||"{}");await $(),await window.emailjs.send(r.serviceId||"service_ly8htul",r.templateReset||"template_cr3mrly",{to_name:c.name,to_email:i,university_id:n,user_name:c.name}),a.textContent=`Password reset email sent to ${i}`,a.style.display="block",document.getElementById("passwordResetForm").reset()}catch(s){console.error("Error sending password reset:",s),o.textContent=s.message||"Failed to send password reset email"}finally{t.disabled=!1,t.textContent="Send Reset Email"}}window.openElectionNotifyModal=async function(){document.getElementById("electionNotifyForm").reset(),document.getElementById("electionNotifyError").textContent="",document.getElementById("electionNotifySuccess").style.display="none",document.getElementById("electionNotifyModal").style.display="flex";const e=document.getElementById("notifyElectionSelect");e.innerHTML='<option value="">Loading...</option>';try{const t=await f(g(m,u.ELECTIONS));e.innerHTML='<option value="">Select an election...</option>',t.forEach(o=>{var s,l,c,i,r,d;const a=o.data(),n=document.createElement("option");n.value=o.id,n.textContent=`${a.title} (${a.status})`,n.dataset.title=a.title,n.dataset.description=a.description||"",n.dataset.startDate=((c=(l=(s=a.start_date)==null?void 0:s.toDate)==null?void 0:l.call(s))==null?void 0:c.toLocaleDateString())||"",n.dataset.endDate=((d=(r=(i=a.end_date)==null?void 0:i.toDate)==null?void 0:r.call(i))==null?void 0:d.toLocaleDateString())||"",n.dataset.faculties=JSON.stringify(a.faculty_scope||[]),e.appendChild(n)})}catch(t){console.error("Error loading elections:",t),e.innerHTML='<option value="">Error loading elections</option>'}};window.closeElectionNotifyModal=function(){document.getElementById("electionNotifyModal").style.display="none"};async function at(e){e.preventDefault();const t=document.getElementById("sendElectionNotifyBtn"),o=document.getElementById("electionNotifyError"),a=document.getElementById("electionNotifySuccess"),n=document.getElementById("notifyElectionSelect"),s=n.value,l=n.options[n.selectedIndex],c=document.getElementById("electionNotifyMessage").value.trim();if(!s){o.textContent="Please select an election";return}t.disabled=!0,t.textContent="Sending...",o.textContent="",a.style.display="none";try{let i=await G();i=i.filter(p=>p.role==="voter"&&p.is_active);const r=JSON.parse(l.dataset.faculties||"[]");if(r.length>0&&(i=i.filter(p=>r.includes(p.faculty))),i.length===0){o.textContent="No eligible voters found";return}const d=await ge(i,{type:"election",title:l.dataset.title,description:c||l.dataset.description,startDate:l.dataset.startDate,endDate:l.dataset.endDate});if(d.success){const p=d.results.filter(y=>y.success).length;a.textContent=`Notification sent to ${p}/${i.length} voters`,a.style.display="block"}else o.textContent=d.error||"Failed to send notifications"}catch(i){console.error("Error sending election notifications:",i),o.textContent=i.message}finally{t.disabled=!1,t.textContent="Send Notifications"}}window.openPollNotifyModal=async function(){document.getElementById("pollNotifyForm").reset(),document.getElementById("pollNotifyError").textContent="",document.getElementById("pollNotifySuccess").style.display="none",document.getElementById("pollNotifyModal").style.display="flex";const e=document.getElementById("notifyPollSelect");e.innerHTML='<option value="">Loading...</option>';try{const t=await f(g(m,u.POLLS));e.innerHTML='<option value="">Select a poll...</option>',t.forEach(o=>{var s,l,c,i,r,d;const a=o.data(),n=document.createElement("option");n.value=o.id,n.textContent=`${a.title} (${a.status})`,n.dataset.title=a.title,n.dataset.description=a.description||"",n.dataset.startDate=((c=(l=(s=a.start_date)==null?void 0:s.toDate)==null?void 0:l.call(s))==null?void 0:c.toLocaleDateString())||"",n.dataset.endDate=((d=(r=(i=a.end_date)==null?void 0:i.toDate)==null?void 0:r.call(i))==null?void 0:d.toLocaleDateString())||"",e.appendChild(n)})}catch(t){console.error("Error loading polls:",t),e.innerHTML='<option value="">Error loading polls</option>'}};window.closePollNotifyModal=function(){document.getElementById("pollNotifyModal").style.display="none"};async function st(e){e.preventDefault();const t=document.getElementById("sendPollNotifyBtn"),o=document.getElementById("pollNotifyError"),a=document.getElementById("pollNotifySuccess"),n=document.getElementById("notifyPollSelect"),s=n.value,l=n.options[n.selectedIndex],c=document.getElementById("pollNotifyMessage").value.trim();if(!s){o.textContent="Please select a poll";return}t.disabled=!0,t.textContent="Sending...",o.textContent="",a.style.display="none";try{let i=await G();if(i=i.filter(d=>d.is_active),i.length===0){o.textContent="No active users found";return}const r=await ge(i,{type:"poll",title:l.dataset.title,description:c||l.dataset.description,startDate:l.dataset.startDate,endDate:l.dataset.endDate});if(r.success){const d=r.results.filter(p=>p.success).length;a.textContent=`Notification sent to ${d}/${i.length} users`,a.style.display="block"}else o.textContent=r.error||"Failed to send notifications"}catch(i){console.error("Error sending poll notifications:",i),o.textContent=i.message}finally{t.disabled=!1,t.textContent="Send Notifications"}}window.openResultsNotifyModal=function(){document.getElementById("resultsNotifyForm").reset(),document.getElementById("resultsNotifyError").textContent="",document.getElementById("resultsNotifySuccess").style.display="none",document.getElementById("resultsSelect").innerHTML='<option value="">Select type first...</option>',document.getElementById("resultsNotifyModal").style.display="flex"};window.closeResultsNotifyModal=function(){document.getElementById("resultsNotifyModal").style.display="none"};window.loadResultsOptions=async function(){const e=document.getElementById("resultsType").value,t=document.getElementById("resultsSelect");if(!e){t.innerHTML='<option value="">Select type first...</option>';return}t.innerHTML='<option value="">Loading...</option>';try{const o=e==="election"?u.ELECTIONS:u.POLLS,a=await f(g(m,o));t.innerHTML=`<option value="">Select ${e}...</option>`,a.forEach(n=>{const s=n.data();if(s.status==="closed"){const l=document.createElement("option");l.value=n.id,l.textContent=s.title,l.dataset.title=s.title,t.appendChild(l)}}),t.options.length===1&&(t.innerHTML=`<option value="">No closed ${e}s found</option>`)}catch(o){console.error("Error loading results options:",o),t.innerHTML='<option value="">Error loading</option>'}};async function lt(e){e.preventDefault();const t=document.getElementById("sendResultsNotifyBtn"),o=document.getElementById("resultsNotifyError"),a=document.getElementById("resultsNotifySuccess"),n=document.getElementById("resultsType").value,s=document.getElementById("resultsSelect"),l=s.value,c=document.getElementById("resultsNotifyMessage").value.trim();if(!n||!l){o.textContent="Please select type and item";return}t.disabled=!0,t.textContent="Sending...",o.textContent="",a.style.display="none";try{const i=s.options[s.selectedIndex];let r=await G();r=r.filter(p=>p.is_active);const d=await He(r,{title:i.dataset.title,winnerName:"See results in app",winnerVotes:"-",totalVotes:"-",customMessage:c});if(d.success){const p=d.results.filter(y=>y.success).length;a.textContent=`Results announcement sent to ${p}/${r.length} users`,a.style.display="block"}else o.textContent=d.error||"Failed to send results"}catch(i){console.error("Error sending results:",i),o.textContent=i.message}finally{t.disabled=!1,t.textContent="Announce Results"}}window.openEmailSettingsModal=function(){document.getElementById("emailSettingsForm").reset(),document.getElementById("settingsError").textContent="",document.getElementById("settingsSuccess").style.display="none";const e=JSON.parse(localStorage.getItem("emailjs_settings")||"{}");document.getElementById("emailPublicKey").value=e.publicKey||"EPO61S4tPNKPKy6UH",document.getElementById("emailServiceId").value=e.serviceId||"service_ly8htul",document.getElementById("templateWelcome").value=e.templateWelcome||"template_sghhqdn",document.getElementById("templateNotify").value=e.templateNotify||"template_exu823x",document.getElementById("templateAnnounce").value=e.templateAnnounce||"template_xs2bkbh",document.getElementById("templateResults").value=e.templateResults||"template_tz1xidg",document.getElementById("templateReset").value=e.templateReset||"template_cr3mrly",document.getElementById("emailSettingsModal").style.display="flex"};window.closeEmailSettingsModal=function(){document.getElementById("emailSettingsModal").style.display="none"};function it(e){e.preventDefault();const t=document.getElementById("settingsError"),o=document.getElementById("settingsSuccess"),a={publicKey:document.getElementById("emailPublicKey").value.trim(),serviceId:document.getElementById("emailServiceId").value.trim(),templateWelcome:document.getElementById("templateWelcome").value.trim(),templateNotify:document.getElementById("templateNotify").value.trim(),templateAnnounce:document.getElementById("templateAnnounce").value.trim(),templateResults:document.getElementById("templateResults").value.trim(),templateReset:document.getElementById("templateReset").value.trim()};if(!a.publicKey||!a.serviceId){t.textContent="Public Key and Service ID are required";return}localStorage.setItem("emailjs_settings",JSON.stringify(a)),o.textContent="‚úÖ Settings saved! Email system is now active and ready to use.",o.style.display="block",t.textContent="",Z()}function ct(){var e,t,o,a,n,s;Z(),(e=document.getElementById("announcementForm"))==null||e.addEventListener("submit",nt),(t=document.getElementById("passwordResetForm"))==null||t.addEventListener("submit",ot),(o=document.getElementById("electionNotifyForm"))==null||o.addEventListener("submit",at),(a=document.getElementById("pollNotifyForm"))==null||a.addEventListener("submit",st),(n=document.getElementById("resultsNotifyForm"))==null||n.addEventListener("submit",lt),(s=document.getElementById("emailSettingsForm"))==null||s.addEventListener("submit",it),["announcementModal","passwordResetModal","electionNotifyModal","pollNotifyModal","resultsNotifyModal","emailSettingsModal"].forEach(l=>{var c;(c=document.getElementById(l))==null||c.addEventListener("click",i=>{i.target.id===l&&(document.getElementById(l).style.display="none")})})}document.addEventListener("DOMContentLoaded",()=>{Ne(),ct(),document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.dataset.page;document.querySelectorAll(".nav-item").forEach(a=>a.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".page").forEach(a=>a.classList.remove("active")),document.getElementById(`${o}Page`).classList.add("active"),rt(o)})})});function rt(e){switch(e){case"elections":R();break;case"candidates":H();break;case"polls":q();break;case"users":z();break;case"results":Ie();break;case"emails":Z();break}}
