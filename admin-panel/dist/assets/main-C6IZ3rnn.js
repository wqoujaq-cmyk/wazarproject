import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as J,deleteApp as ye}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";import{getAuth as z,onAuthStateChanged as be,signOut as H,signInWithEmailAndPassword as De,createUserWithEmailAndPassword as Ce}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";import{getFirestore as Le,getDoc as $,doc as v,getDocs as f,collection as g,deleteDoc as _,query as N,where as A,updateDoc as O,Timestamp as h,setDoc as xe,addDoc as x}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";import{getStorage as Te}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";const Me={apiKey:"AIzaSyApJ-yf788oQncbo2p3E0V9BMAyLEhY_cY",authDomain:"universityevoting2.firebaseapp.com",projectId:"universityevoting2",storageBucket:"universityevoting2.firebasestorage.app",messagingSenderId:"681736971312",appId:"1:681736971312:web:51ff23b2ce275e461ff9f5"},Q=J(Me),T=z(Q),u=Le(Q);Te(Q);const m={USERS:"Users",ELECTIONS:"Elections",CANDIDATES:"Candidates",VOTES:"Votes",POLLS:"Polls",POLL_OPTIONS:"PollOptions",POLL_VOTES:"PollVotes"};let q=null;function Pe(){be(T,async t=>{if(t)try{const e=await $(v(u,m.USERS,t.uid));if(e.exists()){const n=e.data();n.role==="admin"?(q=n,Ae()):(await H(T),Y("Access denied. Admin privileges required."),U())}else await H(T),Y("User data not found"),U()}catch(e){console.error("Error checking user:",e),Y("Error loading user data"),U()}else q=null,U()}),document.getElementById("loginForm").addEventListener("submit",$e),document.getElementById("logoutBtn").addEventListener("click",Ne)}async function $e(t){t.preventDefault();const e=document.getElementById("emailInput").value,n=document.getElementById("passwordInput").value,a=document.getElementById("loginError"),o=document.getElementById("loginBtn"),s=document.getElementById("loginBtnText"),l=document.getElementById("loginBtnSpinner");o.disabled=!0,s.style.display="none",l.style.display="block",a.textContent="";try{await De(T,e,n)}catch(i){console.error("Login error:",i);let r="Login failed. Please try again.";switch(i.code){case"auth/invalid-email":r="Invalid email address";break;case"auth/user-disabled":r="This account has been disabled";break;case"auth/user-not-found":r="No account found with this email";break;case"auth/wrong-password":r="Incorrect password";break}a.textContent=r}finally{o.disabled=!1,s.style.display="block",l.style.display="none"}}async function Ne(){try{await H(T)}catch(t){console.error("Logout error:",t),alert("Error logging out")}}function U(){document.getElementById("loginScreen").style.display="block",document.getElementById("dashboardScreen").style.display="none"}function Ae(){document.getElementById("loginScreen").style.display="none",document.getElementById("dashboardScreen").style.display="block",q&&(document.getElementById("adminName").textContent=q.name||"Admin",Oe())}function Y(t){document.getElementById("loginError").textContent=t}function ge(t){var o,s;const e=new Date,n=(o=t.start_date)!=null&&o.toDate?t.start_date.toDate():new Date(t.start_date),a=(s=t.end_date)!=null&&s.toDate?t.end_date.toDate():new Date(t.end_date);return e<n?"scheduled":e>=n&&e<=a?"active":"closed"}async function Oe(){try{const t=await f(g(u,m.ELECTIONS)),e=[];t.forEach(s=>{e.push({id:s.id,...s.data()})}),document.getElementById("totalElections").textContent=e.length;const n=await f(g(u,m.POLLS)),a=[];n.forEach(s=>{a.push({id:s.id,...s.data()})}),document.getElementById("totalPolls").textContent=a.length;const o=await f(g(u,m.USERS));document.getElementById("totalUsers").textContent=o.size;try{const s=await f(g(u,m.VOTES));document.getElementById("totalVotes").textContent=s.size}catch{document.getElementById("totalVotes").textContent="0"}Re(e),Fe(a)}catch(t){console.error("Error loading dashboard stats:",t),document.getElementById("totalElections").textContent="0",document.getElementById("totalPolls").textContent="0",document.getElementById("totalUsers").textContent="0",document.getElementById("totalVotes").textContent="0"}}function Re(t){const e=document.getElementById("recentElectionsList");if(!e)return;if(t.length===0){e.innerHTML='<p class="no-data">No elections created yet</p>';return}t.sort((a,o)=>{var i,r;const s=(i=a.created_at)!=null&&i.toDate?a.created_at.toDate():new Date(a.start_date);return((r=o.created_at)!=null&&r.toDate?o.created_at.toDate():new Date(o.start_date))-s});let n='<div class="recent-items-grid">';t.slice(0,5).forEach(a=>{var c,d;const o=ge(a),s=(c=a.start_date)!=null&&c.toDate?a.start_date.toDate():new Date(a.start_date),l=(d=a.end_date)!=null&&d.toDate?a.end_date.toDate():new Date(a.end_date),i=o==="active"?"status-active":o==="scheduled"?"status-scheduled":"status-closed",r=o==="active"?"üî¥":o==="scheduled"?"üìÖ":"‚úÖ";n+=`
      <div class="recent-item-card">
        <div class="recent-item-header">
          <h4>${a.title}</h4>
          <span class="status-badge ${i}">${r} ${o.toUpperCase()}</span>
        </div>
        <div class="recent-item-meta">
          <span>üìÖ ${s.toLocaleDateString()} - ${l.toLocaleDateString()}</span>
          <span>üéØ ${a.faculty_scope_type||"All Faculties"}</span>
        </div>
      </div>
    `}),n+="</div>",e.innerHTML=n}function Fe(t){const e=document.getElementById("recentPollsList");if(!e)return;if(t.length===0){e.innerHTML='<p class="no-data">No polls created yet</p>';return}t.sort((a,o)=>{var i,r;const s=(i=a.created_at)!=null&&i.toDate?a.created_at.toDate():new Date(a.start_date);return((r=o.created_at)!=null&&r.toDate?o.created_at.toDate():new Date(o.start_date))-s});let n='<div class="recent-items-grid">';t.slice(0,5).forEach(a=>{var c,d;const o=ge(a),s=(c=a.start_date)!=null&&c.toDate?a.start_date.toDate():new Date(a.start_date),l=(d=a.end_date)!=null&&d.toDate?a.end_date.toDate():new Date(a.end_date),i=o==="active"?"status-active":o==="scheduled"?"status-scheduled":"status-closed",r=o==="active"?"üî¥":o==="scheduled"?"üìÖ":"‚úÖ";n+=`
      <div class="recent-item-card">
        <div class="recent-item-header">
          <h4>${a.title}</h4>
          <span class="status-badge ${i}">${r} ${o.toUpperCase()}</span>
        </div>
        <div class="recent-item-meta">
          <span>üìÖ ${s.toLocaleDateString()} - ${l.toLocaleDateString()}</span>
          <span>üéØ ${a.target_type||"All Faculties"}</span>
        </div>
      </div>
    `}),n+="</div>",e.innerHTML=n}const B={publicKey:"EPO61S4tPNKPKy6UH",serviceId:"service_ly8htul",templates:{welcome:"template_sghhqdn",notification:"template_notify",announcement:"template_announce",results:"template_results"}};function W(){const t=localStorage.getItem("emailjs_settings");if(t){const e=JSON.parse(t);return{publicKey:e.publicKey||B.publicKey,serviceId:e.serviceId||B.serviceId,templates:{welcome:e.templateWelcome||B.templates.welcome,notification:e.templateNotify||B.templates.notification,announcement:e.templateAnnounce||B.templates.announcement,results:e.templateResults||B.templates.results}}}return B}const I={get publicKey(){return W().publicKey},get serviceId(){return W().serviceId},get templates(){return W().templates}};let oe=!1;async function R(){return oe?!0:new Promise((t,e)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js",n.onload=()=>{window.emailjs?(window.emailjs.init(I.publicKey),oe=!0,console.log("EmailJS initialized"),t(!0)):e(new Error("EmailJS failed to load"))},n.onerror=()=>e(new Error("Failed to load EmailJS SDK")),document.head.appendChild(n)})}async function ke(t){try{await R();const e={to_name:t.name,to_email:t.email,university_id:t.university_id,faculty:t.faculty,major:t.major,role:t.role,login_url:window.location.origin},n=await window.emailjs.send(I.serviceId,I.templates.welcome,e);return console.log("Welcome email sent:",n),{success:!0,response:n}}catch(e){return console.error("Failed to send welcome email:",e),{success:!1,error:e.message}}}async function fe(t,e){try{await R();const n=[];for(const a of t){if(!a.contact_email)continue;const o={to_name:a.name,to_email:a.contact_email,notification_type:e.type,title:e.title,description:e.description,start_date:e.startDate,end_date:e.endDate,action_url:window.location.origin};try{const s=await window.emailjs.send(I.serviceId,I.templates.notification,o);n.push({email:o.to_email,success:!0})}catch(s){n.push({email:o.to_email,success:!1,error:s.message})}await new Promise(s=>setTimeout(s,100))}return{success:!0,results:n}}catch(n){return console.error("Failed to send notifications:",n),{success:!1,error:n.message}}}async function Ue(t,e){try{await R();const n=[];for(const a of t){if(!a.contact_email)continue;const o={to_name:a.name,to_email:a.contact_email,subject:e.subject,message:e.message,from_name:e.fromName||"University E-Voting Admin"};try{const s=await window.emailjs.send(I.serviceId,I.templates.announcement,o);n.push({email:o.to_email,success:!0})}catch(s){n.push({email:o.to_email,success:!1,error:s.message})}await new Promise(s=>setTimeout(s,100))}return{success:!0,results:n}}catch(n){return console.error("Failed to send announcement:",n),{success:!1,error:n.message}}}async function He(t,e){try{await R();const n=[];for(const a of t){if(!a.contact_email)continue;const o={to_name:a.name,to_email:a.contact_email,election_title:e.title,winner_name:e.winnerName,winner_votes:e.winnerVotes,total_votes:e.totalVotes,results_url:window.location.origin};try{const s=await window.emailjs.send(I.serviceId,I.templates.results,o);n.push({email:o.to_email,success:!0})}catch(s){n.push({email:o.to_email,success:!1,error:s.message})}await new Promise(s=>setTimeout(s,100))}return{success:!0,results:n}}catch(n){return console.error("Failed to send results:",n),{success:!1,error:n.message}}}function Ee(){return I.publicKey!=="YOUR_PUBLIC_KEY"&&I.serviceId!=="YOUR_SERVICE_ID"}let D=null;async function X(){const t=document.getElementById("usersList");t.innerHTML='<p class="loading">Loading users...</p>';try{const e=await f(g(u,m.USERS));if(e.empty){t.innerHTML='<p class="loading">No users found</p>';return}const n=[];e.forEach(o=>{n.push({id:o.id,...o.data()})}),n.sort((o,s)=>o.name&&s.name?o.name.localeCompare(s.name):0);let a="<table><thead><tr><th>Name</th><th>University ID</th><th>Faculty</th><th>Major</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>";n.forEach(o=>{a+=`
        <tr>
          <td>${o.name||"N/A"}</td>
          <td>${o.university_id||"N/A"}</td>
          <td>${o.faculty||"N/A"}</td>
          <td>${o.major||"N/A"}</td>
          <td><span class="badge ${o.role==="admin"?"badge-scheduled":"badge-active"}">${o.role||"N/A"}</span></td>
          <td><span class="badge ${o.is_active?"badge-active":"badge-inactive"}">${o.is_active?"Active":"Inactive"}</span></td>
          <td>
            <button class="btn btn-secondary" onclick="editUser('${o.id}')">Edit</button>
            <button class="btn btn-warning" onclick="resetUserPassword('${o.id}', '${o.university_id}')">üîë Reset</button>
            <button class="btn btn-danger" onclick="deleteUser('${o.id}')">Delete</button>
          </td>
        </tr>
      `}),a+="</tbody></table>",t.innerHTML=a}catch(e){console.error("Error loading users:",e),t.innerHTML=`<p class="error-message">Error loading users: ${e.message}</p>`}}function ve(){D=null,document.getElementById("userModalTitle").textContent="Add User",document.getElementById("userForm").reset(),document.getElementById("editUserId").value="",document.getElementById("userPassword").required=!0,document.getElementById("passwordHint").textContent="Required for new users (min 6 characters)",document.getElementById("userUniversityId").disabled=!1,document.getElementById("userError").textContent="",document.getElementById("userModal").style.display="flex"}function Z(){document.getElementById("userModal").style.display="none",document.getElementById("userForm").reset(),D=null}window.editUser=async function(t){try{const e=await $(v(u,m.USERS,t));if(!e.exists()){alert("User not found");return}const n=e.data();D=t,document.getElementById("userModalTitle").textContent="Edit User",document.getElementById("editUserId").value=t,document.getElementById("userName").value=n.name||"",document.getElementById("userUniversityId").value=n.university_id||"",document.getElementById("userUniversityId").disabled=!0,document.getElementById("userContactEmail").value=n.contact_email||"",document.getElementById("userPassword").value="",document.getElementById("userPassword").required=!1,document.getElementById("passwordHint").textContent="Leave blank to keep current password",document.getElementById("userFaculty").value=n.faculty||"",document.getElementById("userMajor").value=n.major||"",document.getElementById("userRole").value=n.role||"voter",document.getElementById("userStatus").value=n.is_active?"true":"false",document.getElementById("userError").textContent="",document.getElementById("userModal").style.display="flex"}catch(e){console.error("Error loading user:",e),alert("Error loading user data")}};window.deleteUser=async function(t){if(confirm("Are you sure you want to delete this user? This will only remove the user data, not the authentication account."))try{await _(v(u,m.USERS,t)),alert("User deleted successfully"),X()}catch(e){console.error("Error deleting user:",e),alert("Error deleting user: "+e.message)}};window.resetUserPassword=async function(t,e){const n=prompt(`Reset password for user: ${e}

Enter new password (min 6 characters):`,"");if(n){if(n.length<6){alert("Password must be at least 6 characters");return}if(confirm(`Are you sure you want to reset the password for ${e}?`))try{const o=J({apiKey:"AIzaSyApJ-yf788oQncbo2p3E0V9BMAyLEhY_cY",authDomain:"universityevoting2.firebaseapp.com",projectId:"universityevoting2",storageBucket:"universityevoting2.firebasestorage.app",messagingSenderId:"681736971312",appId:"1:681736971312:web:51ff23b2ce275e461ff9f5"},"PasswordResetApp"),s=z(o),l=`${e.toLowerCase()}@university.edu`;try{alert(`‚ö†Ô∏è Password Reset Limitation

Due to Firebase security, you cannot directly reset a password from the admin panel.

Options:
1. Go to Firebase Console ‚Üí Authentication ‚Üí Users
2. Find user: ${l}
3. Click the menu (‚ãÆ) and select "Reset password"

Or delete and recreate the user with a new password.`)}finally{await ye(o)}}catch(a){console.error("Error resetting password:",a),alert("Error: "+a.message)}}};async function qe(t){t.preventDefault();const e=document.getElementById("userError"),n=document.getElementById("saveUserBtn"),a=document.getElementById("userName").value.trim(),o=document.getElementById("userUniversityId").value.trim().toUpperCase(),s=document.getElementById("userContactEmail").value.trim().toLowerCase(),l=document.getElementById("userPassword").value,i=document.getElementById("userFaculty").value,r=document.getElementById("userMajor").value.trim(),c=document.getElementById("userRole").value,d=document.getElementById("userStatus").value==="true";if(!a||!o||!s||!i||!r){e.textContent="Please fill in all required fields";return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)){e.textContent="Please enter a valid contact email";return}if(!D&&(!l||l.length<6)){e.textContent="Password must be at least 6 characters for new users";return}n.disabled=!0,n.textContent="Saving...",e.textContent="";try{if(D)await O(v(u,m.USERS,D),{name:a,contact_email:s,faculty:i,major:r,role:c,is_active:d,updated_at:h.now()}),alert("User updated successfully!");else{const y=`${o.toLowerCase()}@university.edu`,b=J({apiKey:"AIzaSyApJ-yf788oQncbo2p3E0V9BMAyLEhY_cY",authDomain:"universityevoting2.firebaseapp.com",projectId:"universityevoting2",storageBucket:"universityevoting2.firebasestorage.app",messagingSenderId:"681736971312",appId:"1:681736971312:web:51ff23b2ce275e461ff9f5"},"SecondaryApp"),w=z(b);try{const ne=(await Ce(w,y,l)).user.uid;await H(w),await xe(v(u,m.USERS,ne),{user_id:ne,university_id:o,contact_email:s,name:a,faculty:i,major:r,role:c,is_active:d,photo_url:null,created_at:h.now()});let k="";if(Ee())try{await ke({name:a,email:s,university_id:o,faculty:i,major:r,role:c}),k=`
Welcome email sent to `+s+"!"}catch(_e){console.warn("Failed to send welcome email:",_e),k=`
(Welcome email not sent - check email configuration)`}else k=`
(Email not configured - no welcome email sent)`;alert(`User created successfully!
Login email: `+y+`
Contact email: `+s+k)}finally{await ye(b)}}Z(),X()}catch(y){console.error("Error saving user:",y);let E="Error saving user";y.code==="auth/email-already-in-use"?E="A user with this University ID already exists":y.code==="auth/weak-password"?E="Password is too weak (min 6 characters)":y.code==="auth/invalid-email"?E="Invalid University ID format":E=y.message,e.textContent=E}finally{n.disabled=!1,n.textContent="Save User"}}window.loadPasswordResetRequests=async function(){const t=document.getElementById("passwordResetList");if(t){t.innerHTML='<p class="loading">Loading requests...</p>';try{const e=N(g(u,"PasswordResetTokens"),A("used","==",!1)),n=await f(e);if(n.empty){t.innerHTML=`
        <div class="no-reset-requests">
          <span>‚úÖ</span>
          No pending password reset requests
        </div>
      `;return}const a=[];n.forEach(s=>{a.push({id:s.id,...s.data()})}),a.sort((s,l)=>{var c,d;const i=(c=s.created_at)!=null&&c.toDate?s.created_at.toDate():new Date(s.created_at);return((d=l.created_at)!=null&&d.toDate?l.created_at.toDate():new Date(l.created_at))-i});let o="";a.forEach(s=>{var r;const l=(r=s.created_at)!=null&&r.toDate?s.created_at.toDate():new Date(s.created_at),i=Ve(l);o+=`
        <div class="reset-request-item">
          <div class="reset-request-info">
            <div class="reset-request-user">${s.university_id||"Unknown"}</div>
            <div class="reset-request-email">${s.contact_email||"No email"}</div>
            <div class="reset-request-time">üïê Requested ${i}</div>
          </div>
          <div class="reset-request-actions">
            <button class="btn btn-primary btn-sm" onclick="handleResetRequest('${s.id}', '${s.university_id}', '${s.contact_email||""}')">
              ‚úì Reset Password
            </button>
            <button class="btn btn-danger btn-sm" onclick="dismissResetRequest('${s.id}')">
              ‚úï Dismiss
            </button>
          </div>
        </div>
      `}),t.innerHTML=o}catch(e){console.error("Error loading password reset requests:",e),t.innerHTML=`<p class="error-message">Error: ${e.message}</p>`}}};window.handleResetRequest=async function(t,e,n){const a=`${e.toLowerCase()}@university.edu`,o="https://console.firebase.google.com/project/universityevoting2/authentication/users";alert(`üìã Password Reset Instructions

User: ${e}
Auth Email: ${a}
Contact Email: ${n}

Steps:
1. Go to Firebase Console ‚Üí Authentication
2. Find user: ${a}
3. Click the menu (‚ãÆ) ‚Üí "Reset password"
4. Firebase will send a reset email

OR

Set a new password directly:
Click OK to enter a new password for this user.`);const s=prompt(`Enter new password for ${e}
(min 6 characters, or Cancel to skip):`,"");s&&s.length>=6&&alert(`‚ö†Ô∏è Important:

Firebase Auth passwords cannot be changed from the admin panel.

Please go to Firebase Console:
${o}

Find user "${a}" and reset their password manually.

After reset, notify the user at:
${n}`),confirm("Mark this request as handled?")&&(await O(v(u,"PasswordResetTokens",t),{used:!0,handled_at:h.now(),handled_by:"admin"}),loadPasswordResetRequests())};window.dismissResetRequest=async function(t){if(confirm("Are you sure you want to dismiss this request?"))try{await _(v(u,"PasswordResetTokens",t)),loadPasswordResetRequests()}catch(e){console.error("Error dismissing request:",e),alert("Error: "+e.message)}};function Ve(t){const e=Math.floor((new Date-t)/1e3);return e<60?"just now":e<3600?`${Math.floor(e/60)} minutes ago`:e<86400?`${Math.floor(e/3600)} hours ago`:e<604800?`${Math.floor(e/86400)} days ago`:t.toLocaleDateString()}window.openUserModal=ve;window.closeUserModal=Z;document.addEventListener("DOMContentLoaded",()=>{var t,e,n;(t=document.getElementById("createUserBtn"))==null||t.addEventListener("click",ve),(e=document.getElementById("userForm"))==null||e.addEventListener("submit",qe),loadPasswordResetRequests(),(n=document.getElementById("userModal"))==null||n.addEventListener("click",a=>{a.target.id==="userModal"&&Z()})});let M=null;async function V(){const t=document.getElementById("electionsList");t.innerHTML='<p class="loading">Loading elections...</p>';try{const e=await f(g(u,m.ELECTIONS));if(e.empty){t.innerHTML='<p class="loading">No elections found</p>';return}let n="";e.forEach(a=>{var i,r;const o=a.data(),s=(i=o.start_date)!=null&&i.toDate?o.start_date.toDate():new Date(o.start_date),l=(r=o.end_date)!=null&&r.toDate?o.end_date.toDate():new Date(o.end_date);n+=`
        <div class="list-item">
          <div>
            <div class="list-item-title">${o.title}</div>
            <div class="list-item-subtitle">
              ${o.description||"No description"}<br>
              Start: ${s.toLocaleDateString()} - End: ${l.toLocaleDateString()}<br>
              Faculty Scope: ${o.faculty_scope_type}
            </div>
          </div>
          <div>
            <span class="badge badge-${je(o.status)}">${o.status}</span>
            <div class="list-item-actions">
              <button class="btn btn-secondary" onclick="editElection('${a.id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteElection('${a.id}')">Delete</button>
            </div>
          </div>
        </div>
      `}),t.innerHTML=n}catch(e){console.error("Error loading elections:",e),t.innerHTML='<p class="error-message">Error loading elections</p>'}}function je(t){switch(t){case"active":return"active";case"scheduled":return"scheduled";case"closed":return"closed";case"draft":return"draft";default:return"inactive"}}function ae(t){const e=new Date(t),n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0");return`${n}-${a}-${o}T${s}:${l}`}window.editElection=async function(t){var e,n;try{const a=document.getElementById("electionModal"),o=document.getElementById("electionModalTitle"),s=await $(v(u,m.ELECTIONS,t));if(!s.exists()){alert("Election not found");return}const l=s.data();M=t,o.textContent="Edit Election",document.getElementById("electionTitle").value=l.title||"",document.getElementById("electionDescription").value=l.description||"",document.getElementById("electionScopeType").value=l.faculty_scope_type||"",document.getElementById("electionStatus").value=l.status||"draft";const i=(e=l.start_date)!=null&&e.toDate?l.start_date.toDate():new Date(l.start_date),r=(n=l.end_date)!=null&&n.toDate?l.end_date.toDate():new Date(l.end_date);document.getElementById("electionStartDate").value=ae(i),document.getElementById("electionEndDate").value=ae(r);const c=l.faculty_scope_type,d=document.getElementById("facultyScopeGroup");c==="SINGLE_FACULTY"||c==="MULTI_FACULTY"?(d.style.display="block",document.querySelectorAll('#facultyCheckboxes input[type="checkbox"]').forEach(y=>y.checked=!1),l.faculty_scope&&Array.isArray(l.faculty_scope)&&l.faculty_scope.forEach(y=>{const E=document.querySelector(`#facultyCheckboxes input[value="${y}"]`);E&&(E.checked=!0)})):d.style.display="none",document.getElementById("electionError").textContent="",a.classList.add("active")}catch(a){console.error("Error loading election for edit:",a),alert("Error loading election: "+a.message)}};window.deleteElection=async function(t){if(confirm("Are you sure you want to delete this election? This action cannot be undone."))try{await _(v(u,m.ELECTIONS,t)),alert("Election deleted successfully"),V()}catch(e){console.error("Error deleting election:",e),alert("Error deleting election")}};window.openElectionModal=function(){M=null,document.getElementById("electionModalTitle").textContent="Create Election",document.getElementById("electionForm").reset(),document.getElementById("facultyScopeGroup").style.display="none",document.getElementById("electionError").textContent="",document.getElementById("electionModal").classList.add("active")};window.closeElectionModal=function(){document.getElementById("electionModal").classList.remove("active"),document.getElementById("electionForm").reset(),document.getElementById("facultyScopeGroup").style.display="none",document.getElementById("electionError").textContent="",M=null};window.toggleFacultySelect=function(){const t=document.getElementById("electionScopeType").value,e=document.getElementById("facultyScopeGroup");t==="SINGLE_FACULTY"||t==="MULTI_FACULTY"?e.style.display="block":e.style.display="none"};var ie;(ie=document.getElementById("electionForm"))==null||ie.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("electionTitle").value.trim(),n=document.getElementById("electionDescription").value.trim(),a=document.getElementById("electionScopeType").value,o=new Date(document.getElementById("electionStartDate").value),s=new Date(document.getElementById("electionEndDate").value),l=document.getElementById("electionStatus").value;if(!e){document.getElementById("electionError").textContent="Please enter a title";return}if(!a){document.getElementById("electionError").textContent="Please select a faculty scope type";return}if(s<=o){document.getElementById("electionError").textContent="End date must be after start date";return}let i=[];if(a!=="ALL_FACULTIES"){const c=document.querySelectorAll("#facultyCheckboxes input:checked");if(i=Array.from(c).map(d=>d.value),i.length===0){document.getElementById("electionError").textContent="Please select at least one faculty";return}}const r={title:e,description:n,faculty_scope_type:a,faculty_scope:i,start_date:h.fromDate(o),end_date:h.fromDate(s),status:l,updated_at:h.now()};try{M?(await O(v(u,m.ELECTIONS,M),r),closeElectionModal(),V(),alert("Election updated successfully!")):(r.created_at=h.now(),await x(g(u,m.ELECTIONS),r),closeElectionModal(),V(),alert("Election created successfully!"))}catch(c){console.error("Error saving election:",c),document.getElementById("electionError").textContent="Error saving election: "+c.message}});var ce;(ce=document.getElementById("createElectionBtn"))==null||ce.addEventListener("click",openElectionModal);let P=null;async function j(){const t=document.getElementById("candidatesList");t.innerHTML='<p class="loading">Loading candidates...</p>';try{const e=await f(g(u,m.CANDIDATES));if(e.empty){t.innerHTML='<p class="loading">No candidates found</p>';return}let n="<table><thead><tr><th>Name</th><th>Faculty</th><th>Election ID</th><th>Bio</th><th>Actions</th></tr></thead><tbody>";e.forEach(a=>{const o=a.data(),s=o.bio?o.bio.substring(0,50)+"...":"N/A";n+=`
        <tr>
          <td>${o.name}</td>
          <td>${o.faculty}</td>
          <td>${o.election_id}</td>
          <td>${s}</td>
          <td>
            <button class="btn btn-secondary" onclick="editCandidate('${a.id}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteCandidate('${a.id}')">Delete</button>
          </td>
        </tr>
      `}),n+="</tbody></table>",t.innerHTML=n}catch(e){console.error("Error loading candidates:",e),t.innerHTML='<p class="error-message">Error loading candidates</p>'}}async function he(){try{const t=await f(g(u,m.ELECTIONS)),e=document.getElementById("candidateElection");return e.innerHTML='<option value="">Select election...</option>',t.forEach(n=>{const a=n.data(),o=document.createElement("option");o.value=n.id,o.textContent=a.title,e.appendChild(o)}),!0}catch(t){return console.error("Error loading elections:",t),!1}}window.editCandidate=async function(t){try{const e=await $(v(u,m.CANDIDATES,t));if(!e.exists()){alert("Candidate not found");return}const n=e.data();P=t;const a=document.querySelector("#candidateModal .modal-header h2");a&&(a.textContent="Edit Candidate"),await he(),document.getElementById("candidateName").value=n.name||"",document.getElementById("candidateElection").value=n.election_id||"",document.getElementById("candidateFaculty").value=n.faculty||"",document.getElementById("candidateBio").value=n.bio||"",document.getElementById("candidateError").textContent="",document.getElementById("candidateModal").classList.add("active")}catch(e){console.error("Error loading candidate for edit:",e),alert("Error loading candidate: "+e.message)}};window.deleteCandidate=async function(t){if(confirm("Are you sure you want to delete this candidate? This action cannot be undone."))try{await _(v(u,m.CANDIDATES,t)),alert("Candidate deleted successfully"),j()}catch(e){console.error("Error deleting candidate:",e),alert("Error deleting candidate")}};window.openCandidateModal=async function(){P=null;const t=document.querySelector("#candidateModal .modal-header h2");t&&(t.textContent="Add Candidate"),document.getElementById("candidateForm").reset(),document.getElementById("candidateError").textContent="",await he(),document.getElementById("candidateModal").classList.add("active")};window.closeCandidateModal=function(){document.getElementById("candidateModal").classList.remove("active"),document.getElementById("candidateForm").reset(),document.getElementById("candidateError").textContent="",P=null};var de;(de=document.getElementById("candidateForm"))==null||de.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("candidateName").value.trim(),n=document.getElementById("candidateElection").value,a=document.getElementById("candidateFaculty").value,o=document.getElementById("candidateBio").value.trim();if(!e){document.getElementById("candidateError").textContent="Please enter a name";return}if(!n){document.getElementById("candidateError").textContent="Please select an election";return}if(!a){document.getElementById("candidateError").textContent="Please select a faculty";return}const s={name:e,election_id:n,faculty:a,bio:o,updated_at:h.now()};try{P?(await O(v(u,m.CANDIDATES,P),s),closeCandidateModal(),j(),alert("Candidate updated successfully!")):(s.photo_url=null,s.created_at=h.now(),await x(g(u,m.CANDIDATES),s),closeCandidateModal(),j(),alert("Candidate added successfully!"))}catch(l){console.error("Error saving candidate:",l),document.getElementById("candidateError").textContent="Error saving candidate: "+l.message}});var ue;(ue=document.getElementById("createCandidateBtn"))==null||ue.addEventListener("click",openCandidateModal);let S=null;async function K(){const t=document.getElementById("pollsList");t.innerHTML='<p class="loading">Loading polls...</p>';try{const e=await f(g(u,m.POLLS));if(e.empty){t.innerHTML='<p class="loading">No polls found</p>';return}let n="";e.forEach(a=>{var i,r;const o=a.data(),s=(i=o.start_date)!=null&&i.toDate?o.start_date.toDate():new Date(o.start_date),l=(r=o.end_date)!=null&&r.toDate?o.end_date.toDate():new Date(o.end_date);n+=`
        <div class="list-item">
          <div>
            <div class="list-item-title">${o.title}</div>
            <div class="list-item-subtitle">
              ${o.description||"No description"}<br>
              Start: ${s.toLocaleDateString()} - End: ${l.toLocaleDateString()}<br>
              Target: ${o.target_type}
            </div>
          </div>
          <div>
            <span class="badge badge-${Ke(o.status)}">${o.status}</span>
            <div class="list-item-actions">
              <button class="btn btn-secondary" onclick="editPoll('${a.id}')">Edit</button>
              <button class="btn btn-danger" onclick="deletePoll('${a.id}')">Delete</button>
            </div>
          </div>
        </div>
      `}),t.innerHTML=n}catch(e){console.error("Error loading polls:",e),t.innerHTML='<p class="error-message">Error loading polls</p>'}}function Ke(t){switch(t){case"active":return"active";case"scheduled":return"scheduled";case"closed":return"closed";case"draft":return"draft";default:return"inactive"}}function se(t){const e=new Date(t),n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0");return`${n}-${a}-${o}T${s}:${l}`}window.editPoll=async function(t){var e,n;try{const a=await $(v(u,m.POLLS,t));if(!a.exists()){alert("Poll not found");return}const o=a.data();S=t;const s=document.querySelector("#pollModal .modal-header h2");s&&(s.textContent="Edit Poll"),document.getElementById("pollTitle").value=o.title||"",document.getElementById("pollDescription").value=o.description||"",document.getElementById("pollTargetType").value=o.target_type||"",document.getElementById("pollStatus").value=o.status||"draft";const l=(e=o.start_date)!=null&&e.toDate?o.start_date.toDate():new Date(o.start_date),i=(n=o.end_date)!=null&&n.toDate?o.end_date.toDate():new Date(o.end_date);document.getElementById("pollStartDate").value=se(l),document.getElementById("pollEndDate").value=se(i);const r=o.target_type,c=document.getElementById("pollFacultyScopeGroup");r==="SINGLE_FACULTY"||r==="MULTI_FACULTY"?(c.style.display="block",document.querySelectorAll('#pollFacultyCheckboxes input[type="checkbox"]').forEach(y=>y.checked=!1),o.target_faculties&&Array.isArray(o.target_faculties)&&o.target_faculties.forEach(y=>{const E=document.querySelector(`#pollFacultyCheckboxes input[value="${y}"]`);E&&(E.checked=!0)})):c.style.display="none";const d=document.getElementById("pollOptionsContainer");d.innerHTML="";try{const p=await f(N(g(u,m.POLL_OPTIONS),A("poll_id","==",t)));if(p.empty)d.innerHTML=`
          <input type="text" class="poll-option" placeholder="Option 1" required>
          <input type="text" class="poll-option" placeholder="Option 2" required>
        `;else{const y=[];p.forEach(E=>{y.push({id:E.id,...E.data()})}),y.sort((E,b)=>(E.order||0)-(b.order||0)),y.forEach((E,b)=>{const w=document.createElement("input");w.type="text",w.className="poll-option",w.placeholder=`Option ${b+1}`,w.required=!0,w.value=E.text||"",w.dataset.optionId=E.id,d.appendChild(w)})}}catch(p){console.error("Error loading poll options:",p),d.innerHTML=`
        <input type="text" class="poll-option" placeholder="Option 1" required>
        <input type="text" class="poll-option" placeholder="Option 2" required>
      `}document.getElementById("pollError").textContent="",document.getElementById("pollModal").classList.add("active")}catch(a){console.error("Error loading poll for edit:",a),alert("Error loading poll: "+a.message)}};window.deletePoll=async function(t){if(confirm("Are you sure you want to delete this poll? This will also delete all poll options and votes."))try{const e=await f(N(g(u,m.POLL_OPTIONS),A("poll_id","==",t))),n=[];e.forEach(a=>{n.push(_(v(u,m.POLL_OPTIONS,a.id)))}),await Promise.all(n),await _(v(u,m.POLLS,t)),alert("Poll deleted successfully"),K()}catch(e){console.error("Error deleting poll:",e),alert("Error deleting poll")}};window.openPollModal=function(){S=null;const t=document.querySelector("#pollModal .modal-header h2");t&&(t.textContent="Create Poll"),document.getElementById("pollForm").reset(),document.getElementById("pollFacultyScopeGroup").style.display="none",document.getElementById("pollError").textContent="",document.getElementById("pollOptionsContainer").innerHTML=`
    <input type="text" class="poll-option" placeholder="Option 1" required>
    <input type="text" class="poll-option" placeholder="Option 2" required>
  `,document.getElementById("pollModal").classList.add("active")};window.closePollModal=function(){document.getElementById("pollModal").classList.remove("active"),document.getElementById("pollForm").reset(),document.getElementById("pollFacultyScopeGroup").style.display="none",document.getElementById("pollError").textContent="",S=null,document.getElementById("pollOptionsContainer").innerHTML=`
    <input type="text" class="poll-option" placeholder="Option 1" required>
    <input type="text" class="poll-option" placeholder="Option 2" required>
  `};window.togglePollFacultySelect=function(){const t=document.getElementById("pollTargetType").value,e=document.getElementById("pollFacultyScopeGroup");t==="SINGLE_FACULTY"||t==="MULTI_FACULTY"?e.style.display="block":e.style.display="none"};window.addPollOption=function(){const t=document.getElementById("pollOptionsContainer"),e=t.querySelectorAll(".poll-option").length+1,n=document.createElement("input");n.type="text",n.className="poll-option",n.placeholder=`Option ${e}`,n.required=!0,t.appendChild(n)};var me;(me=document.getElementById("pollForm"))==null||me.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("pollTitle").value.trim(),n=document.getElementById("pollDescription").value.trim(),a=document.getElementById("pollTargetType").value,o=new Date(document.getElementById("pollStartDate").value),s=new Date(document.getElementById("pollEndDate").value),l=document.getElementById("pollStatus").value;if(!e){document.getElementById("pollError").textContent="Please enter a poll question";return}if(!a){document.getElementById("pollError").textContent="Please select a target type";return}if(s<=o){document.getElementById("pollError").textContent="End date must be after start date";return}let i=[];if(a!=="ALL_FACULTIES"){const p=document.querySelectorAll("#pollFacultyCheckboxes input:checked");if(i=Array.from(p).map(y=>y.value),i.length===0){document.getElementById("pollError").textContent="Please select at least one faculty";return}}const r=document.querySelectorAll(".poll-option"),c=Array.from(r).map(p=>({text:p.value.trim(),id:p.dataset.optionId||null})).filter(p=>p.text);if(c.length<2){document.getElementById("pollError").textContent="Please provide at least 2 options";return}const d={title:e,description:n,target_type:a,target_faculties:i,start_date:h.fromDate(o),end_date:h.fromDate(s),status:l,updated_at:h.now()};try{if(S){await O(v(u,m.POLLS,S),d);const p=await f(N(g(u,m.POLL_OPTIONS),A("poll_id","==",S))),y=[];p.forEach(E=>{y.push(_(v(u,m.POLL_OPTIONS,E.id)))}),await Promise.all(y);for(let E=0;E<c.length;E++)await x(g(u,m.POLL_OPTIONS),{poll_id:S,text:c[E].text,order:E});closePollModal(),K(),alert("Poll updated successfully!")}else{d.created_at=h.now();const p=await x(g(u,m.POLLS),d);for(let y=0;y<c.length;y++)await x(g(u,m.POLL_OPTIONS),{poll_id:p.id,text:c[y].text,order:y});closePollModal(),K(),alert("Poll created successfully!")}}catch(p){console.error("Error saving poll:",p),document.getElementById("pollError").textContent="Error saving poll: "+p.message}});var pe;(pe=document.getElementById("createPollBtn"))==null||pe.addEventListener("click",openPollModal);let le=[],C=null;function Ie(t){document.querySelectorAll(".results-tab").forEach(n=>{n.classList.remove("active"),n.dataset.tab===t&&n.classList.add("active")}),document.querySelectorAll(".results-tab-content").forEach(n=>{n.classList.remove("active")});const e=document.getElementById(`${t}-tab`);e&&e.classList.add("active")}window.switchResultsTab=Ie;function we(){console.log("Initializing Results Page..."),Ie("active-elections"),ee(),Ge()}function Ge(){C&&clearInterval(C),C=setInterval(()=>{ee()},3e4)}function Ye(){C&&(clearInterval(C),C=null)}function We(){le.forEach(t=>t()),le=[]}async function ee(){console.log("Loading all results...");try{await Promise.all([ze(),Qe(),Xe(),Je()]),console.log("All results loaded successfully")}catch(t){console.error("Error loading results:",t)}}function F(t){var o,s;const e=new Date,n=(o=t.start_date)!=null&&o.toDate?t.start_date.toDate():new Date(t.start_date),a=(s=t.end_date)!=null&&s.toDate?t.end_date.toDate():new Date(t.end_date);return e<n?"scheduled":e>=n&&e<=a?"active":"closed"}function L(t){const e=document.getElementById(t);e&&(e.textContent=`Updated: ${new Date().toLocaleTimeString()}`)}async function Je(){try{const t=await f(g(u,m.ELECTIONS));let e=0;t.forEach(d=>{d.data().status==="active"&&e++});const n=document.getElementById("activeElectionsCount");n&&(n.textContent=e);const a=await f(g(u,m.POLLS));let o=0;a.forEach(d=>{d.data().status==="active"&&o++});const s=document.getElementById("activePollsCount");s&&(s.textContent=o);const l=await f(g(u,m.VOTES)),i=document.getElementById("totalVotesCast");i&&(i.textContent=l.size);const r=new Set;l.forEach(d=>{const p=d.data();p.user_id&&r.add(p.user_id)});const c=document.getElementById("totalParticipants");c&&(c.textContent=r.size)}catch(t){console.error("Error loading stats:",t)}}async function ze(){const t=document.getElementById("activeElectionsList");if(!t){console.warn("activeElectionsList container not found");return}t.innerHTML='<p class="loading">Loading active elections...</p>';try{const e=await f(g(u,m.ELECTIONS)),n=[];if(e.forEach(o=>{const s=o.data(),l=F(s);(l==="active"||l==="scheduled")&&n.push({id:o.id,...s,actualStatus:l})}),console.log(`Found ${n.length} active/scheduled elections`),n.length===0){t.innerHTML=`
        <div class="no-results">
          <div class="no-results-icon">üó≥Ô∏è</div>
          <h4>No Active Elections</h4>
          <p>There are no elections currently in progress.</p>
        </div>
      `,L("activeElectionsUpdateTime");return}let a="";for(const o of n){const s=await Be(o.id);a+=Se(o,s,!0)}t.innerHTML=a,L("activeElectionsUpdateTime")}catch(e){console.error("Error loading active elections:",e),t.innerHTML='<p class="error-message">Error loading active elections</p>'}}async function Qe(){const t=document.getElementById("closedElectionsList");if(!t){console.warn("closedElectionsList container not found");return}t.innerHTML='<p class="loading">Loading closed elections...</p>';try{const e=await f(g(u,m.ELECTIONS)),n=[];if(e.forEach(o=>{const s=o.data(),l=F(s);l==="closed"&&n.push({id:o.id,...s,actualStatus:l})}),console.log(`Found ${n.length} closed elections`),n.length===0){t.innerHTML=`
        <div class="no-results">
          <div class="no-results-icon">‚úÖ</div>
          <h4>No Closed Elections</h4>
          <p>Completed elections will appear here.</p>
        </div>
      `,L("closedElectionsUpdateTime");return}let a="";for(const o of n){const s=await Be(o.id);a+=Se(o,s,!1)}t.innerHTML=a,L("closedElectionsUpdateTime")}catch(e){console.error("Error loading closed elections:",e),t.innerHTML='<p class="error-message">Error loading closed elections</p>'}}async function Be(t){const e={candidates:[],totalVotes:0};try{const n=await f(g(u,m.VOTES)),a={};n.forEach(s=>{const l=s.data();l.election_id===t&&(a[l.candidate_id]=(a[l.candidate_id]||0)+1,e.totalVotes++)}),(await f(g(u,m.CANDIDATES))).forEach(s=>{const l=s.data();if(l.election_id===t){const i=a[s.id]||0,r=e.totalVotes>0?i/e.totalVotes*100:0;e.candidates.push({id:s.id,name:l.name,faculty:l.faculty,bio:l.bio,votes:i,percentage:r})}}),e.candidates.sort((s,l)=>l.votes-s.votes)}catch(n){console.error("Error getting election results:",n)}return e}function Se(t,e,n){var r,c;const a=(r=t.start_date)!=null&&r.toDate?t.start_date.toDate():new Date(t.start_date),o=(c=t.end_date)!=null&&c.toDate?t.end_date.toDate():new Date(t.end_date),s=t.actualStatus||F(t),l=n&&s==="active"?'<span class="badge badge-active">üî¥ LIVE</span>':`<span class="badge badge-${s}">${s}</span>`;let i="";return e.candidates.length===0?i='<p class="loading" style="text-align: center; padding: 20px;">No candidates registered</p>':e.candidates.forEach((d,p)=>{const y=p===0&&e.totalVotes>0;i+=`
        <div class="candidate-result-item ${y&&!n?"winner":""}">
          <div class="candidate-rank">${p+1}</div>
          <div class="candidate-info">
            <div class="candidate-name">
              ${d.name}
              ${y&&!n?'<span class="winner-badge">üèÜ Winner</span>':""}
            </div>
            <div class="candidate-faculty">${d.faculty}</div>
          </div>
          <div class="candidate-votes-section">
            <div class="vote-progress-container">
              <div class="vote-progress-bar" style="width: ${d.percentage}%"></div>
            </div>
            <div class="candidate-vote-count">
              <div class="vote-number">${d.votes}</div>
              <div class="vote-percentage">${d.percentage.toFixed(1)}%</div>
            </div>
          </div>
        </div>
      `}),`
    <div class="election-result-card ${n&&s==="active"?"live":""}">
      <div class="election-card-header">
        <div class="election-card-info">
          <h4>${t.title}</h4>
          <div class="election-card-meta">
            <span>üìÖ ${a.toLocaleDateString()} - ${o.toLocaleDateString()}</span>
            <span>üéØ ${t.faculty_scope_type||"All"}</span>
            ${l}
          </div>
        </div>
        <div class="election-card-stats">
          <div class="election-stat">
            <div class="election-stat-value">${e.totalVotes}</div>
            <div class="election-stat-label">Total Votes</div>
          </div>
          <div class="election-stat">
            <div class="election-stat-value">${e.candidates.length}</div>
            <div class="election-stat-label">Candidates</div>
          </div>
        </div>
      </div>
      <div class="candidates-results-list">
        ${i}
      </div>
    </div>
  `}async function Xe(){const t=document.getElementById("pollResultsList");if(!t){console.warn("pollResultsList container not found");return}t.innerHTML='<p class="loading">Loading poll results...</p>';try{const e=await f(g(u,m.POLLS));if(e.empty){t.innerHTML=`
        <div class="no-results">
          <div class="no-results-icon">üìä</div>
          <h4>No Polls</h4>
          <p>Poll results will appear here.</p>
        </div>
      `,L("pollsUpdateTime");return}let n="";const a=[];e.forEach(o=>{const s=o.data(),l=F(s);a.push({id:o.id,...s,actualStatus:l})}),console.log(`Found ${a.length} polls`);for(const o of a){const s=await Ze(o.id);n+=et(o,s)}t.innerHTML=n||`
      <div class="no-results">
        <div class="no-results-icon">üìä</div>
        <h4>No Polls</h4>
        <p>Poll results will appear here.</p>
      </div>
    `,L("pollsUpdateTime")}catch(e){console.error("Error loading polls:",e),t.innerHTML='<p class="error-message">Error loading poll results</p>'}}async function Ze(t){const e={options:[],totalVotes:0};try{const n=await f(g(u,m.POLL_OPTIONS)),a=[];n.forEach(l=>{const i=l.data();i.poll_id===t&&a.push({id:l.id,...i})}),a.sort((l,i)=>(l.order||0)-(i.order||0));const o=await f(g(u,m.POLL_VOTES)),s={};if(o.forEach(l=>{const i=l.data();i.poll_id===t&&(s[i.option_id]=(s[i.option_id]||0)+1,e.totalVotes++)}),a.forEach(l=>{const i=s[l.id]||0,r=e.totalVotes>0?i/e.totalVotes*100:0;e.options.push({id:l.id,text:l.text,votes:i,percentage:r})}),e.options.length>0){const l=Math.max(...e.options.map(i=>i.votes));l>0&&e.options.forEach(i=>{i.isWinner=i.votes===l})}}catch(n){console.error("Error getting poll results:",n)}return e}function et(t,e){var l,i;const n=(l=t.start_date)!=null&&l.toDate?t.start_date.toDate():new Date(t.start_date),a=(i=t.end_date)!=null&&i.toDate?t.end_date.toDate():new Date(t.end_date),o=t.actualStatus||F(t);let s="";return e.options.length===0?s='<p class="loading" style="text-align: center;">No options available</p>':e.options.forEach(r=>{const c=Math.max(r.percentage,r.votes>0?8:0);s+=`
        <div class="poll-option-item ${r.isWinner?"winner":""}">
          <div class="poll-option-header">
            <span class="poll-option-text">${r.text} ${r.isWinner?"üèÜ":""}</span>
            <span class="poll-option-votes">${r.votes} votes</span>
          </div>
          <div class="poll-option-bar">
            <div class="poll-option-fill" style="width: ${c}%">
              ${r.percentage>0?`<span>${r.percentage.toFixed(1)}%</span>`:""}
            </div>
          </div>
        </div>
      `}),`
    <div class="poll-result-card">
      <div class="poll-card-header">
        <h4>${t.title}</h4>
        <div class="poll-card-meta">
          <span>üìÖ ${n.toLocaleDateString()} - ${a.toLocaleDateString()}</span>
          <span>üéØ ${t.target_type||"All"}</span>
          <span class="badge badge-${o}">${o}</span>
          <span>üìä ${e.totalVotes} total votes</span>
        </div>
      </div>
      <div class="poll-options-list">
        ${s}
      </div>
    </div>
  `}window.refreshAllResults=function(){const t=document.getElementById("refreshResultsBtn");t&&(t.disabled=!0,t.innerHTML="‚è≥ Refreshing..."),ee().then(()=>{t&&(t.disabled=!1,t.innerHTML="üîÑ Refresh")})};const tt=new MutationObserver(t=>{t.forEach(e=>{e.target.id==="resultsPage"&&(e.target.classList.contains("active")?we():(Ye(),We()))})}),re=document.getElementById("resultsPage");re&&tt.observe(re,{attributes:!0,attributeFilter:["class"]});async function te(){const t=document.getElementById("emailConfigStatus");if(!t)return;Ee()?(t.innerHTML=`
      <div class="config-ok">
        <span class="status-icon">‚úÖ</span>
        <span>Email service is configured and ready</span>
      </div>
    `,t.className="config-status config-ok"):(t.innerHTML=`
      <div class="config-warning">
        <span class="status-icon">‚ö†Ô∏è</span>
        <span>Email service not configured. Click "Configure" to set up EmailJS.</span>
      </div>
    `,t.className="config-status config-warning")}async function G(){const t=await f(g(u,m.USERS)),e=[];return t.forEach(n=>{e.push({id:n.id,...n.data()})}),e}async function nt(t,e=null){let n=await G();switch(t){case"voters":return n.filter(a=>a.role==="voter");case"admins":return n.filter(a=>a.role==="admin");case"faculty":return n.filter(a=>a.faculty===e);case"all":default:return n}}window.openAnnouncementModal=function(){document.getElementById("announcementForm").reset(),document.getElementById("announcementError").textContent="",document.getElementById("announcementSuccess").style.display="none",document.getElementById("announcementFacultyGroup").style.display="none",document.getElementById("announcementModal").style.display="flex",document.getElementById("announcementTarget").addEventListener("change",function(){document.getElementById("announcementFacultyGroup").style.display=this.value==="faculty"?"block":"none"})};window.closeAnnouncementModal=function(){document.getElementById("announcementModal").style.display="none"};async function ot(t){t.preventDefault();const e=document.getElementById("sendAnnouncementBtn"),n=document.getElementById("announcementError"),a=document.getElementById("announcementSuccess"),o=document.getElementById("announcementSubject").value.trim(),s=document.getElementById("announcementMessage").value.trim(),l=document.getElementById("announcementTarget").value,i=document.getElementById("announcementFaculty").value;if(!o||!s){n.textContent="Please fill in all required fields";return}e.disabled=!0,e.textContent="Sending...",n.textContent="",a.style.display="none";try{const r=await nt(l,i);if(r.length===0){n.textContent="No recipients found for the selected filter";return}const c=await Ue(r,{subject:o,message:s,fromName:"University E-Voting Admin"});if(c.success){const d=c.results.filter(p=>p.success).length;a.textContent=`Announcement sent to ${d}/${r.length} recipients`,a.style.display="block",document.getElementById("announcementForm").reset()}else n.textContent=c.error||"Failed to send announcement"}catch(r){console.error("Error sending announcement:",r),n.textContent=r.message}finally{e.disabled=!1,e.textContent="Send Announcement"}}window.openPasswordResetModal=function(){document.getElementById("passwordResetForm").reset(),document.getElementById("resetError").textContent="",document.getElementById("resetSuccess").style.display="none",document.getElementById("passwordResetModal").style.display="flex"};window.closePasswordResetModal=function(){document.getElementById("passwordResetModal").style.display="none"};async function at(t){t.preventDefault();const e=document.getElementById("sendResetBtn"),n=document.getElementById("resetError"),a=document.getElementById("resetSuccess"),o=document.getElementById("resetUniversityId").value.trim().toUpperCase();if(!o){n.textContent="Please enter a University ID";return}e.disabled=!0,e.textContent="Sending...",n.textContent="",a.style.display="none";try{const s=N(g(u,m.USERS),A("university_id","==",o)),l=await f(s);if(l.empty){n.textContent="No user found with this University ID";return}const i=l.docs[0].data(),r=i.contact_email;if(!r){n.textContent="No contact email found for this user";return}const c=JSON.parse(localStorage.getItem("emailjs_settings")||"{}");await R(),await window.emailjs.send(c.serviceId||"service_ly8htul",c.templateReset||"template_cr3mrly",{to_name:i.name,to_email:r,university_id:o,user_name:i.name}),a.textContent=`Password reset email sent to ${r}`,a.style.display="block",document.getElementById("passwordResetForm").reset()}catch(s){console.error("Error sending password reset:",s),n.textContent=s.message||"Failed to send password reset email"}finally{e.disabled=!1,e.textContent="Send Reset Email"}}window.openElectionNotifyModal=async function(){document.getElementById("electionNotifyForm").reset(),document.getElementById("electionNotifyError").textContent="",document.getElementById("electionNotifySuccess").style.display="none",document.getElementById("electionNotifyModal").style.display="flex";const t=document.getElementById("notifyElectionSelect");t.innerHTML='<option value="">Loading...</option>';try{const e=await f(g(u,m.ELECTIONS));t.innerHTML='<option value="">Select an election...</option>',e.forEach(n=>{var s,l,i,r,c,d;const a=n.data(),o=document.createElement("option");o.value=n.id,o.textContent=`${a.title} (${a.status})`,o.dataset.title=a.title,o.dataset.description=a.description||"",o.dataset.startDate=((i=(l=(s=a.start_date)==null?void 0:s.toDate)==null?void 0:l.call(s))==null?void 0:i.toLocaleDateString())||"",o.dataset.endDate=((d=(c=(r=a.end_date)==null?void 0:r.toDate)==null?void 0:c.call(r))==null?void 0:d.toLocaleDateString())||"",o.dataset.faculties=JSON.stringify(a.faculty_scope||[]),t.appendChild(o)})}catch(e){console.error("Error loading elections:",e),t.innerHTML='<option value="">Error loading elections</option>'}};window.closeElectionNotifyModal=function(){document.getElementById("electionNotifyModal").style.display="none"};async function st(t){t.preventDefault();const e=document.getElementById("sendElectionNotifyBtn"),n=document.getElementById("electionNotifyError"),a=document.getElementById("electionNotifySuccess"),o=document.getElementById("notifyElectionSelect"),s=o.value,l=o.options[o.selectedIndex],i=document.getElementById("electionNotifyMessage").value.trim();if(!s){n.textContent="Please select an election";return}e.disabled=!0,e.textContent="Sending...",n.textContent="",a.style.display="none";try{let r=await G();r=r.filter(p=>p.role==="voter"&&p.is_active);const c=JSON.parse(l.dataset.faculties||"[]");if(c.length>0&&(r=r.filter(p=>c.includes(p.faculty))),r.length===0){n.textContent="No eligible voters found";return}const d=await fe(r,{type:"election",title:l.dataset.title,description:i||l.dataset.description,startDate:l.dataset.startDate,endDate:l.dataset.endDate});if(d.success){const p=d.results.filter(y=>y.success).length;a.textContent=`Notification sent to ${p}/${r.length} voters`,a.style.display="block"}else n.textContent=d.error||"Failed to send notifications"}catch(r){console.error("Error sending election notifications:",r),n.textContent=r.message}finally{e.disabled=!1,e.textContent="Send Notifications"}}window.openPollNotifyModal=async function(){document.getElementById("pollNotifyForm").reset(),document.getElementById("pollNotifyError").textContent="",document.getElementById("pollNotifySuccess").style.display="none",document.getElementById("pollNotifyModal").style.display="flex";const t=document.getElementById("notifyPollSelect");t.innerHTML='<option value="">Loading...</option>';try{const e=await f(g(u,m.POLLS));t.innerHTML='<option value="">Select a poll...</option>',e.forEach(n=>{var s,l,i,r,c,d;const a=n.data(),o=document.createElement("option");o.value=n.id,o.textContent=`${a.title} (${a.status})`,o.dataset.title=a.title,o.dataset.description=a.description||"",o.dataset.startDate=((i=(l=(s=a.start_date)==null?void 0:s.toDate)==null?void 0:l.call(s))==null?void 0:i.toLocaleDateString())||"",o.dataset.endDate=((d=(c=(r=a.end_date)==null?void 0:r.toDate)==null?void 0:c.call(r))==null?void 0:d.toLocaleDateString())||"",t.appendChild(o)})}catch(e){console.error("Error loading polls:",e),t.innerHTML='<option value="">Error loading polls</option>'}};window.closePollNotifyModal=function(){document.getElementById("pollNotifyModal").style.display="none"};async function lt(t){t.preventDefault();const e=document.getElementById("sendPollNotifyBtn"),n=document.getElementById("pollNotifyError"),a=document.getElementById("pollNotifySuccess"),o=document.getElementById("notifyPollSelect"),s=o.value,l=o.options[o.selectedIndex],i=document.getElementById("pollNotifyMessage").value.trim();if(!s){n.textContent="Please select a poll";return}e.disabled=!0,e.textContent="Sending...",n.textContent="",a.style.display="none";try{let r=await G();if(r=r.filter(d=>d.is_active),r.length===0){n.textContent="No active users found";return}const c=await fe(r,{type:"poll",title:l.dataset.title,description:i||l.dataset.description,startDate:l.dataset.startDate,endDate:l.dataset.endDate});if(c.success){const d=c.results.filter(p=>p.success).length;a.textContent=`Notification sent to ${d}/${r.length} users`,a.style.display="block"}else n.textContent=c.error||"Failed to send notifications"}catch(r){console.error("Error sending poll notifications:",r),n.textContent=r.message}finally{e.disabled=!1,e.textContent="Send Notifications"}}window.openResultsNotifyModal=function(){document.getElementById("resultsNotifyForm").reset(),document.getElementById("resultsNotifyError").textContent="",document.getElementById("resultsNotifySuccess").style.display="none",document.getElementById("resultsSelect").innerHTML='<option value="">Select type first...</option>',document.getElementById("resultsNotifyModal").style.display="flex"};window.closeResultsNotifyModal=function(){document.getElementById("resultsNotifyModal").style.display="none"};window.loadResultsOptions=async function(){const t=document.getElementById("resultsType").value,e=document.getElementById("resultsSelect");if(!t){e.innerHTML='<option value="">Select type first...</option>';return}e.innerHTML='<option value="">Loading...</option>';try{const n=t==="election"?m.ELECTIONS:m.POLLS,a=await f(g(u,n));e.innerHTML=`<option value="">Select ${t}...</option>`,a.forEach(o=>{const s=o.data();if(s.status==="closed"){const l=document.createElement("option");l.value=o.id,l.textContent=s.title,l.dataset.title=s.title,e.appendChild(l)}}),e.options.length===1&&(e.innerHTML=`<option value="">No closed ${t}s found</option>`)}catch(n){console.error("Error loading results options:",n),e.innerHTML='<option value="">Error loading</option>'}};async function rt(t){t.preventDefault();const e=document.getElementById("sendResultsNotifyBtn"),n=document.getElementById("resultsNotifyError"),a=document.getElementById("resultsNotifySuccess"),o=document.getElementById("resultsType").value,s=document.getElementById("resultsSelect"),l=s.value,i=document.getElementById("resultsNotifyMessage").value.trim();if(!o||!l){n.textContent="Please select type and item";return}e.disabled=!0,e.textContent="Sending...",n.textContent="",a.style.display="none";try{const r=s.options[s.selectedIndex];let c=await G();c=c.filter(p=>p.is_active);const d=await He(c,{title:r.dataset.title,winnerName:"See results in app",winnerVotes:"-",totalVotes:"-",customMessage:i});if(d.success){const p=d.results.filter(y=>y.success).length;a.textContent=`Results announcement sent to ${p}/${c.length} users`,a.style.display="block"}else n.textContent=d.error||"Failed to send results"}catch(r){console.error("Error sending results:",r),n.textContent=r.message}finally{e.disabled=!1,e.textContent="Announce Results"}}window.openEmailSettingsModal=function(){document.getElementById("emailSettingsForm").reset(),document.getElementById("settingsError").textContent="",document.getElementById("settingsSuccess").style.display="none";const t=JSON.parse(localStorage.getItem("emailjs_settings")||"{}");document.getElementById("emailPublicKey").value=t.publicKey||"EPO61S4tPNKPKy6UH",document.getElementById("emailServiceId").value=t.serviceId||"service_ly8htul",document.getElementById("templateWelcome").value=t.templateWelcome||"template_sghhqdn",document.getElementById("templateNotify").value=t.templateNotify||"template_exu823x",document.getElementById("templateAnnounce").value=t.templateAnnounce||"template_xs2bkbh",document.getElementById("templateResults").value=t.templateResults||"template_tz1xidg",document.getElementById("templateReset").value=t.templateReset||"template_cr3mrly",document.getElementById("emailSettingsModal").style.display="flex"};window.closeEmailSettingsModal=function(){document.getElementById("emailSettingsModal").style.display="none"};function it(t){t.preventDefault();const e=document.getElementById("settingsError"),n=document.getElementById("settingsSuccess"),a={publicKey:document.getElementById("emailPublicKey").value.trim(),serviceId:document.getElementById("emailServiceId").value.trim(),templateWelcome:document.getElementById("templateWelcome").value.trim(),templateNotify:document.getElementById("templateNotify").value.trim(),templateAnnounce:document.getElementById("templateAnnounce").value.trim(),templateResults:document.getElementById("templateResults").value.trim(),templateReset:document.getElementById("templateReset").value.trim()};if(!a.publicKey||!a.serviceId){e.textContent="Public Key and Service ID are required";return}localStorage.setItem("emailjs_settings",JSON.stringify(a)),n.textContent="‚úÖ Settings saved! Email system is now active and ready to use.",n.style.display="block",e.textContent="",te()}function ct(){var t,e,n,a,o,s;te(),(t=document.getElementById("announcementForm"))==null||t.addEventListener("submit",ot),(e=document.getElementById("passwordResetForm"))==null||e.addEventListener("submit",at),(n=document.getElementById("electionNotifyForm"))==null||n.addEventListener("submit",st),(a=document.getElementById("pollNotifyForm"))==null||a.addEventListener("submit",lt),(o=document.getElementById("resultsNotifyForm"))==null||o.addEventListener("submit",rt),(s=document.getElementById("emailSettingsForm"))==null||s.addEventListener("submit",it),["announcementModal","passwordResetModal","electionNotifyModal","pollNotifyModal","resultsNotifyModal","emailSettingsModal"].forEach(l=>{var i;(i=document.getElementById(l))==null||i.addEventListener("click",r=>{r.target.id===l&&(document.getElementById(l).style.display="none")})})}document.addEventListener("DOMContentLoaded",()=>{Pe(),ct(),document.querySelectorAll(".nav-item").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.page;document.querySelectorAll(".nav-item").forEach(a=>a.classList.remove("active")),t.classList.add("active"),document.querySelectorAll(".page").forEach(a=>a.classList.remove("active")),document.getElementById(`${n}Page`).classList.add("active"),dt(n)})})});function dt(t){switch(t){case"elections":V();break;case"candidates":j();break;case"polls":K();break;case"users":X();break;case"results":we();break;case"emails":te();break}}
