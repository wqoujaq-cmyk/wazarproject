import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as V}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";import{getAuth as R}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";import{getFirestore as $,query as I,collection as E,where as d,getDocs as L,doc as B,getDoc as z,updateDoc as Q}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";const N={apiKey:"AIzaSyApJ-yf788oQncbo2p3E0V9BMAyLEhY_cY",authDomain:"universityevoting2.firebaseapp.com",projectId:"universityevoting2",storageBucket:"universityevoting2.firebasestorage.app",messagingSenderId:"681736971312",appId:"1:681736971312:web:51ff23b2ce275e461ff9f5"},q=V(N);R(q);const u=$(q);let x=null,Y=null,C=null;const b=document.getElementById("verifyForm"),f=document.getElementById("passwordForm"),Z=document.getElementById("successView"),S=document.getElementById("alertContainer"),U=document.getElementById("stepSubtitle"),D=document.getElementById("step1Dot"),y=document.getElementById("step2Dot"),j=document.getElementById("step3Dot"),_=new URLSearchParams(window.location.search),k=_.get("token"),P=_.get("id");k&&(document.getElementById("resetToken").value=k);P&&(document.getElementById("universityId").value=P.toUpperCase());function c(t,e){const s={error:"❌",success:"✅",warning:"⚠️"};S.innerHTML=`
                <div class="alert alert-${t}">
                    <span class="alert-icon">${s[t]}</span>
                    <span>${e}</span>
                </div>
            `}function A(){S.innerHTML=""}window.togglePassword=function(t){const e=document.getElementById(t);e.type=e.type==="password"?"text":"password"};const m=document.getElementById("newPassword"),o=document.getElementById("confirmPassword"),i=document.getElementById("resetBtn"),w=document.getElementById("strengthFill"),T=document.getElementById("strengthText");m.addEventListener("input",G);o.addEventListener("input",F);function G(){const t=m.value;let e=0,s={length:!1,upper:!1,lower:!1,number:!1};t.length>=8&&(e++,s.length=!0),/[A-Z]/.test(t)&&(e++,s.upper=!0),/[a-z]/.test(t)&&(e++,s.lower=!0),/[0-9]/.test(t)&&(e++,s.number=!0),l("reqLength",s.length),l("reqUpper",s.upper),l("reqLower",s.lower),l("reqNumber",s.number);const n=["var(--error)","var(--warning)","#eab308","var(--success)"],r=["Weak","Fair","Good","Strong"],a=["25%","50%","75%","100%"];t.length===0?(w.style.width="0%",T.textContent="Enter a password"):(w.style.width=a[e-1]||"0%",w.style.background=n[e-1]||n[0],T.textContent=r[e-1]||"Very weak"),F()}function l(t,e){const s=document.getElementById(t);e?(s.classList.add("met"),s.querySelector(".requirement-icon").textContent="✓"):(s.classList.remove("met"),s.querySelector(".requirement-icon").textContent="○")}function F(){const t=m.value,e=o.value,s=t.length>=8&&/[A-Z]/.test(t)&&/[a-z]/.test(t)&&/[0-9]/.test(t),n=t===e&&e.length>0;i.disabled=!(s&&n),e.length>0&&!n?(o.classList.add("error"),o.classList.remove("success")):n?(o.classList.remove("error"),o.classList.add("success")):o.classList.remove("error","success")}b.addEventListener("submit",async t=>{t.preventDefault(),A();const e=document.getElementById("universityId").value.toUpperCase().trim(),s=document.getElementById("resetToken").value.trim();if(!e||!s){c("error","Please fill in all fields");return}const n=document.getElementById("verifyBtn");n.disabled=!0,n.innerHTML='<div class="spinner"></div>';try{const r=I(E(u,"Users"),d("university_id","==",e)),a=await L(r);if(a.empty)throw new Error("No account found with this University ID");const g=a.docs[0],H=g.data(),M=I(E(u,"PasswordResetTokens"),d("university_id","==",e),d("token","==",s),d("used","==",!1)),v=await L(M);if(v.empty)throw new Error("Invalid or expired reset token. Please request a new one.");const h=v.docs[0],p=h.data().created_at.toDate();if(p.setHours(p.getHours()+24),new Date>p)throw new Error("This reset token has expired. Please request a new one.");x=g.id,Y=`${e.toLowerCase()}@university.edu`,C=h.id,b.classList.add("hidden"),f.classList.remove("hidden"),D.classList.remove("active"),D.classList.add("completed"),y.classList.add("active"),U.textContent="Create a new secure password for your account",c("success",`Identity verified for ${H.name}. Please set your new password.`)}catch(r){console.error("Verification error:",r),c("error",r.message||"Verification failed. Please try again.")}finally{n.disabled=!1,n.innerHTML="<span>Verify Identity</span>"}});f.addEventListener("submit",async t=>{t.preventDefault(),A();const e=m.value,s=o.value;if(e!==s){c("error","Passwords do not match");return}i.disabled=!0,i.innerHTML='<div class="spinner"></div>';try{const n=B(u,"Users",x),r=await z(n);if(!r.exists())throw new Error("User not found");const a=r.data();await Q(B(u,"PasswordResetTokens",C),{requested_password:e,password_submitted:!0,submitted_at:new Date,user_name:a.name||"Unknown",contact_email:a.contact_email||""}),f.classList.add("hidden"),Z.classList.remove("hidden"),y.classList.remove("active"),y.classList.add("completed"),j.classList.add("active"),U.textContent=""}catch(n){console.error("Password reset error:",n),c("error",n.message||"Failed to submit password reset request. Please try again."),i.disabled=!1,i.innerHTML="<span>Reset Password</span>"}});
