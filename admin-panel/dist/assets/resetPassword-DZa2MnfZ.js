import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as R}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";import{getAuth as V}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";import{getFirestore as $,query as I,collection as E,where as d,getDocs as L,doc as D,getDoc as G,updateDoc as B}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";const N={apiKey:"AIzaSyCw3WEk0MShGTwLEpO7I8Y85Jv97n06fc4",authDomain:"wazar-1a851.firebaseapp.com",projectId:"wazar-1a851",storageBucket:"wazar-1a851.firebasestorage.app",messagingSenderId:"1091521735952",appId:"1:1091521735952:web:4c04c10f77e9c71e9c1dfe"},x=R(N);V(x);const u=$(x);let C=null,Q=null,S=null;const b=document.getElementById("verifyForm"),f=document.getElementById("passwordForm"),W=document.getElementById("successView"),_=document.getElementById("alertContainer"),U=document.getElementById("stepSubtitle"),k=document.getElementById("step1Dot"),g=document.getElementById("step2Dot"),Z=document.getElementById("step3Dot"),F=new URLSearchParams(window.location.search),P=F.get("token"),T=F.get("id");P&&(document.getElementById("resetToken").value=P);T&&(document.getElementById("universityId").value=T.toUpperCase());function c(t,e){const s={error:"❌",success:"✅",warning:"⚠️"};_.innerHTML=`
                <div class="alert alert-${t}">
                    <span class="alert-icon">${s[t]}</span>
                    <span>${e}</span>
                </div>
            `}function H(){_.innerHTML=""}window.togglePassword=function(t){const e=document.getElementById(t);e.type=e.type==="password"?"text":"password"};const m=document.getElementById("newPassword"),o=document.getElementById("confirmPassword"),i=document.getElementById("resetBtn"),w=document.getElementById("strengthFill"),q=document.getElementById("strengthText");m.addEventListener("input",j);o.addEventListener("input",z);function j(){const t=m.value;let e=0,s={length:!1,upper:!1,lower:!1,number:!1};t.length>=8&&(e++,s.length=!0),/[A-Z]/.test(t)&&(e++,s.upper=!0),/[a-z]/.test(t)&&(e++,s.lower=!0),/[0-9]/.test(t)&&(e++,s.number=!0),l("reqLength",s.length),l("reqUpper",s.upper),l("reqLower",s.lower),l("reqNumber",s.number);const n=["var(--error)","var(--warning)","#eab308","var(--success)"],r=["Weak","Fair","Good","Strong"],a=["25%","50%","75%","100%"];t.length===0?(w.style.width="0%",q.textContent="Enter a password"):(w.style.width=a[e-1]||"0%",w.style.background=n[e-1]||n[0],q.textContent=r[e-1]||"Very weak"),z()}function l(t,e){const s=document.getElementById(t);e?(s.classList.add("met"),s.querySelector(".requirement-icon").textContent="✓"):(s.classList.remove("met"),s.querySelector(".requirement-icon").textContent="○")}function z(){const t=m.value,e=o.value,s=t.length>=8&&/[A-Z]/.test(t)&&/[a-z]/.test(t)&&/[0-9]/.test(t),n=t===e&&e.length>0;i.disabled=!(s&&n),e.length>0&&!n?(o.classList.add("error"),o.classList.remove("success")):n?(o.classList.remove("error"),o.classList.add("success")):o.classList.remove("error","success")}b.addEventListener("submit",async t=>{t.preventDefault(),H();const e=document.getElementById("universityId").value.toUpperCase().trim(),s=document.getElementById("resetToken").value.trim();if(!e||!s){c("error","Please fill in all fields");return}const n=document.getElementById("verifyBtn");n.disabled=!0,n.innerHTML='<div class="spinner"></div>';try{const r=I(E(u,"Users"),d("university_id","==",e)),a=await L(r);if(a.empty)throw new Error("No account found with this University ID");const y=a.docs[0],A=y.data(),M=I(E(u,"PasswordResetTokens"),d("university_id","==",e),d("token","==",s),d("used","==",!1)),v=await L(M);if(v.empty)throw new Error("Invalid or expired reset token. Please request a new one.");const h=v.docs[0],p=h.data().created_at.toDate();if(p.setHours(p.getHours()+24),new Date>p)throw new Error("This reset token has expired. Please request a new one.");C=y.id,Q=`${e.toLowerCase()}@university.edu`,S=h.id,b.classList.add("hidden"),f.classList.remove("hidden"),k.classList.remove("active"),k.classList.add("completed"),g.classList.add("active"),U.textContent="Create a new secure password for your account",c("success",`Identity verified for ${A.name}. Please set your new password.`)}catch(r){console.error("Verification error:",r),c("error",r.message||"Verification failed. Please try again.")}finally{n.disabled=!1,n.innerHTML="<span>Verify Identity</span>"}});f.addEventListener("submit",async t=>{t.preventDefault(),H();const e=m.value,s=o.value;if(e!==s){c("error","Passwords do not match");return}i.disabled=!0,i.innerHTML='<div class="spinner"></div>';try{const n=D(u,"Users",C),r=await G(n);if(!r.exists())throw new Error("User not found");const a=r.data();await B(D(u,"PasswordResetTokens",S),{requested_password:e,password_submitted:!0,submitted_at:new Date,user_name:a.name||"Unknown",contact_email:a.contact_email||""}),await B(n,{password_reset_pending:!0,password_reset_requested_at:new Date}),f.classList.add("hidden"),W.classList.remove("hidden"),g.classList.remove("active"),g.classList.add("completed"),Z.classList.add("active"),U.textContent=""}catch(n){console.error("Password reset error:",n),c("error",n.message||"Failed to submit password reset request. Please try again."),i.disabled=!1,i.innerHTML="<span>Reset Password</span>"}});
