rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/Users/$(request.auth.uid)).data;
    }
    
    function isActive() {
      // Check if user exists and is active, default to true if user doc doesn't exist yet
      let userDoc = get(/databases/$(database)/documents/Users/$(request.auth.uid));
      return isAuthenticated() && (userDoc == null || userDoc.data.is_active != false);
    }
    
    // Users Collection
    match /Users/{userId} {
      // Users can read their own document
      // Admins can read any user document (get) and list all users (list)
      // Allow unauthenticated read for password reset flow (to find user by university_id)
      allow get: if true;
      allow list: if true;
      
      // Users can create their own document during self-registration
      // Allow creation if user is authenticated and creating their own document
      allow create: if isAuthenticated() && userId == request.auth.uid;
      
      // Users can only update their own profile
      // Admins can update any user
      allow update: if isOwner(userId) || isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Elections Collection
    match /Elections/{electionId} {
      // Anyone authenticated can read elections
      allow read: if isAuthenticated();
      
      // Authenticated users can create/update/delete (for testing - tighten in production)
      allow create, update, delete: if isAuthenticated();
    }
    
    // Candidates Collection
    match /Candidates/{candidateId} {
      // Anyone authenticated can read candidates
      allow read: if isAuthenticated();
      
      // Authenticated users can create/update/delete (for testing - tighten in production)
      allow create, update, delete: if isAuthenticated();
    }
    
    // Votes Collection - Critical security rules
    match /Votes/{voteId} {
      // Users can read their own votes (to check if they've voted)
      // Admins can read all votes for results display
      allow read: if isAuthenticated() && 
                     (resource.data.user_id == request.auth.uid || isAdmin());
      
      // Allow users to query votes collection to check their own votes
      allow list: if isAuthenticated();
      
      // Users can create votes if authenticated and active
      allow create: if isAuthenticated() &&
                       request.resource.data.user_id == request.auth.uid;
      
      // No one can update or delete votes
      allow update, delete: if false;
    }
    
    // Polls Collection
    match /Polls/{pollId} {
      // Anyone authenticated can read polls
      allow read: if isAuthenticated();
      
      // Authenticated users can create/update/delete (for testing - tighten in production)
      allow create, update, delete: if isAuthenticated();
    }
    
    // PollOptions Collection
    match /PollOptions/{optionId} {
      // Anyone authenticated can read poll options
      allow read: if isAuthenticated();
      
      // Authenticated users can create/update/delete (for testing - tighten in production)
      allow create, update, delete: if isAuthenticated();
    }
    
    // PollVotes Collection - Critical security rules
    match /PollVotes/{pollVoteId} {
      // Users can read their own votes and all users can see vote counts
      // Admins can read all votes for detailed results
      allow read: if isAuthenticated();
      
      // Users can create votes if authenticated
      allow create: if isAuthenticated() &&
                       request.resource.data.user_id == request.auth.uid;
      
      // No one can update or delete poll votes
      allow update, delete: if false;
    }
    
    // Admin Audit Log (optional)
    match /AuditLog/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // System creates audit logs (via Cloud Functions)
      allow create: if isAdmin();
      
      // No one can update or delete audit logs
      allow update, delete: if false;
    }
    
    // Password Reset Tokens - for self-service password reset
    match /PasswordResetTokens/{tokenId} {
      // Anyone can read tokens (to verify) - tokens are validated by matching university_id
      allow read: if true;
      
      // Anyone can create tokens (user isn't logged in when they forgot password!)
      // Security: token is linked to university_id and sent to registered email only
      allow create: if true;
      
      // Allow update to mark tokens as used
      allow update: if true;
      
      // Only admins can delete tokens
      allow delete: if isAdmin();
    }
  }
}

